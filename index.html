<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Estoque</title>
  <style>
    :root {
      --bg-color: #f5f7fb;
      --chip-bg: #ffffff;
      --accent: #3f51b5;
      --accent-light: #5c6bc0;
      --text: #1f2933;
      --muted: #52606d;
      --border-radius: 18px;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    body {
      margin: 0;
      padding: 24px;
      background: linear-gradient(135deg, #e3eeff 0%, #f8f9ff 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .app-shell {
      display: flex;
      gap: 24px;
      width: 100%;
      max-width: 1400px;
    }

    .sidebar {
      background: var(--chip-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 20px;
      min-width: 220px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: fit-content;
    }

    .sidebar-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .nav-button {
      border: none;
      background: transparent;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--muted);
      text-align: left;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }

    .nav-button:hover {
      background: rgba(63, 81, 181, 0.08);
      color: var(--accent);
    }

    .nav-button.active {
      background: rgba(63, 81, 181, 0.12);
      color: var(--accent);
      box-shadow: inset 0 0 0 1px rgba(63, 81, 181, 0.2);
    }

    .page-container {
      flex: 1;
      min-width: 0;
    }

    .page {
      display: none;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .page.active {
      display: block;
    }

    h1 {
      text-align: center;
      color: var(--accent);
      margin-bottom: 24px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .layout-grid {
      display: grid;
      gap: 24px;
      max-width: 1200px;
      margin: 0 auto 48px auto;
    }

    .chip {
      background: var(--chip-bg);
      border-radius: var(--border-radius);
      padding: 18px 22px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .chip-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .inputs-row {
      display: grid;
      gap: 16px;
    }

    .inputs-row.double {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    label {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
      color: var(--muted);
      gap: 6px;
    }

    input[type="text"],
    input[type="number"],
    select {
      border: 1px solid #d1d5db;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 1rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
    }

    .button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .button.secondary {
      background: #e5e7eb;
      color: var(--text);
    }

    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(63, 81, 181, 0.25);
    }

    .button.secondary:hover {
      box-shadow: 0 8px 16px rgba(148, 163, 184, 0.25);
    }

    .button-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .manual-actions {
      display: flex;
      align-items: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .stats-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .stat-card {
      background: rgba(63, 81, 181, 0.07);
      border-radius: 16px;
      padding: 14px 18px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .stat-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 1px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--accent-light);
      word-break: break-word;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 18px;
      box-shadow: var(--shadow);
      background: var(--chip-bg);
    }

    .inventory-header {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }

    .inventory-instructions {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
      flex: 1 1 240px;
    }

    .hidden-file-input {
      display: none;
    }

    .saldo-loja-input {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 0.95rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    .saldo-loja-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
    }

    .status-dot {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      display: inline-block;
      background: #cbd5f5;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.6);
    }

    .status-dot--ok {
      background: #22c55e;
    }

    .status-dot--alert {
      background: #ef4444;
    }

    .status-dot--pending {
      background: #9ca3af;
    }

    .empty-state {
      margin-top: 16px;
      text-align: center;
      color: var(--muted);
      font-size: 0.95rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 320px;
    }

    thead {
      background: var(--accent);
      color: white;
    }

    th,
    td {
      padding: 14px 18px;
      text-align: left;
    }

    tbody tr:nth-child(even) {
      background: rgba(63, 81, 181, 0.08);
    }

    .table-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .table-action {
      background: rgba(63, 81, 181, 0.12);
      border: none;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 0.85rem;
      color: var(--accent);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.15s ease;
    }

    .table-action:hover {
      background: rgba(63, 81, 181, 0.22);
      transform: translateY(-1px);
    }

    .sort-button {
      border: none;
      background: rgba(255, 255, 255, 0.25);
      color: white;
      border-radius: 12px;
      padding: 4px 10px;
      margin-left: 10px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .table-title {
      font-weight: 600;
      color: var(--muted);
      padding: 16px 20px 0 20px;
    }

    @media (max-width: 640px) {
      body {
        padding: 16px;
      }

      .chip {
        padding: 16px;
      }
    }

    @media (max-width: 960px) {
      .app-shell {
        flex-direction: column;
      }

      .sidebar {
        flex-direction: row;
        align-items: center;
        gap: 8px;
        overflow-x: auto;
      }

      .sidebar-title {
        display: none;
      }

      .nav-button {
        flex: 1 0 auto;
        text-align: center;
      }
    }

    /* Print layout */
    @media print {
      body {
        background: white;
        padding: 0;
      }

      .layout-grid,
      .table-section {
        display: none;
      }

      #print-area {
        display: block !important;
        padding: 32px;
        font-size: 12pt;
      }

      #print-title {
        font-size: 18pt;
        font-weight: 700;
        margin-bottom: 18px;
      }

      .print-columns {
        display: flex;
        gap: 24px;
      }

      .print-column {
        flex: 1;
      }

      .print-column table {
        width: 100%;
        border-collapse: collapse;
      }

      .print-column th,
      .print-column td {
        border: 1px solid #1f2933;
        padding: 8px;
        text-align: left;
      }
    }

    #print-area {
      display: none;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--chip-bg);
      border-radius: 18px;
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 420px;
      padding: 24px;
      display: none;
      flex-direction: column;
      gap: 16px;
    }

    .modal.active {
      display: flex;
    }

    .modal h2 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--accent);
    }

    .modal-code {
      font-size: 0.95rem;
      color: var(--muted);
    }

    .modal-message {
      min-height: 24px;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-title">Paginação</div>
      <button class="nav-button active" data-target="manual-page">Contagem Manual</button>
      <button class="nav-button" data-target="conferencia-page">Conferência de Estoque</button>
    </aside>
    <main class="page-container">
      <section class="page active" id="manual-page">
        <h1>Controle de Estoque</h1>

        <div class="layout-grid">
          <div class="chip" id="data-entry-chip">
            <div class="chip-section-title">Inserção de Dados</div>
            <div class="inputs-row">
              <label for="auto-code">
                Campo Automático (Leitor)
                <input id="auto-code" type="text" autocomplete="off" spellcheck="false" placeholder="Aproxime o leitor aqui" />
              </label>
            </div>
            <div class="inputs-row double">
              <label for="manual-code">
                Código Manual
                <input id="manual-code" type="text" placeholder="Informe o código" />
              </label>
              <label for="manual-qty">
                Quantidade
                <input id="manual-qty" type="number" min="1" value="1" />
              </label>
              <div class="manual-actions">
                <button class="button" id="manual-add">Adicionar</button>
                <button class="button secondary" id="manual-check">Conferir</button>
              </div>
            </div>
            <div class="inputs-row double">
              <label for="store-select">
                Loja
                <select id="store-select">
                  <option value="Jorel Chicuta">Jorel Chicuta</option>
                  <option value="Jorel Avenida">Jorel Avenida</option>
                  <option value="Exótica">Exótica</option>
                </select>
              </label>
              <label for="product-select">
                Produto
                <select id="product-select">
                  <option value="Anel">Anel</option>
                  <option value="Brinco">Brinco</option>
                  <option value="Pingente">Pingente</option>
                  <option value="Corrente">Corrente</option>
                  <option value="Pulseira">Pulseira</option>
                  <option value="Aliança">Aliança</option>
                  <option value="Relógio">Relógio</option>
                  <option value="Armação">Armação</option>
                  <option value="Solar">Solar</option>
                  <option value="Outro">Outro</option>
                </select>
              </label>
            </div>
          </div>

          <div class="chip">
            <div class="chip-section-title">Resumo Atual</div>
            <div class="stats-grid">
              <div class="stat-card">
                <span class="stat-label">Quantidade Total</span>
                <span class="stat-value" id="total-quantity">0</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">Último Código</span>
                <span class="stat-value" id="last-code">---</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">Loja</span>
                <span class="stat-value" id="summary-store">Jorel Chicuta</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">Produto</span>
                <span class="stat-value" id="summary-product">Anel</span>
              </div>
            </div>
          </div>

          <div class="chip">
            <div class="chip-section-title">Salvar e Exportar</div>
            <div class="button-group">
              <button class="button" id="print-pdf">Imprimir PDF</button>
              <button class="button" id="save-data">Salvar</button>
              <button class="button secondary" id="reset-data">Resetar</button>
              <button class="button" id="download-table">Baixar Tabela</button>
            </div>
          </div>
        </div>

        <div class="table-section">
          <div class="table-title">Tabela de Códigos</div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>
                    Código
                    <button class="sort-button" id="sort-toggle">Ordem ↑</button>
                  </th>
                  <th>Quantidade</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="table-body"></tbody>
            </table>
          </div>
        </div>

        <div id="print-area">
          <div id="print-title"></div>
          <div class="print-columns">
            <div class="print-column">
              <table>
                <thead>
                  <tr><th>Código</th><th>Quantidade</th></tr>
                </thead>
                <tbody id="print-table-left"></tbody>
              </table>
            </div>
            <div class="print-column">
              <table>
                <thead>
                  <tr><th>Código</th><th>Quantidade</th></tr>
                </thead>
                <tbody id="print-table-right"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section class="page" id="conferencia-page">
        <h1>Conferência de Estoque</h1>

        <div class="chip">
          <div class="inventory-header">
            <button class="button" id="import-xls">Importar XLS</button>
            <input type="file" id="xls-input" accept=".xls,.xlsx" class="hidden-file-input" />
            <p class="inventory-instructions">Importe um arquivo contendo as colunas Código, Produto e Saldo Contábil.</p>
          </div>
        </div>

        <div class="table-section">
          <div class="table-title">Saldos Conferidos</div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Código</th>
                  <th>Produto</th>
                  <th>Saldo Contábil</th>
                  <th>Saldo em Loja</th>
                  <th>OK</th>
                </tr>
              </thead>
              <tbody id="inventory-table-body"></tbody>
            </table>
          </div>
          <div class="empty-state" id="inventory-empty">Importe um arquivo XLS para visualizar os saldos.</div>
        </div>
      </section>
    </main>
  </div>

  <div id="modal-overlay" class="modal-overlay">
    <div class="modal" id="verify-modal">
      <h2>Conferir Produto</h2>
      <label for="verify-code">
        Código
        <input id="verify-code" type="text" autocomplete="off" spellcheck="false" placeholder="Informe o código" />
      </label>
      <div class="modal-message" id="verify-message"></div>
      <div class="modal-buttons">
        <button class="button secondary" id="verify-close">Fechar</button>
        <button class="button" id="verify-submit">Verificar</button>
      </div>
      <div class="modal-buttons hidden" id="verify-prompt">
        <button class="button secondary" id="verify-no-edit">Não</button>
        <button class="button" id="verify-yes-edit">Sim</button>
      </div>
    </div>

    <div class="modal" id="edit-modal">
      <h2>Editar Item</h2>
      <div class="modal-code">Código: <strong id="edit-code-display"></strong></div>
      <label for="edit-qty">
        Quantidade
        <input id="edit-qty" type="number" min="1" />
      </label>
      <div class="modal-buttons">
        <button class="button secondary" id="edit-cancel">Cancelar</button>
        <button class="button" id="edit-save">Salvar</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const navButtons = document.querySelectorAll('.nav-button');
    const pages = document.querySelectorAll('.page');
    const manualPage = document.getElementById('manual-page');
    const autoInput = document.getElementById('auto-code');
    const manualCodeInput = document.getElementById('manual-code');
    const manualQtyInput = document.getElementById('manual-qty');
    const manualAddButton = document.getElementById('manual-add');
    const manualCheckButton = document.getElementById('manual-check');
    const storeSelect = document.getElementById('store-select');
    const productSelect = document.getElementById('product-select');
    const totalQuantityEl = document.getElementById('total-quantity');
    const lastCodeEl = document.getElementById('last-code');
    const summaryStoreEl = document.getElementById('summary-store');
    const summaryProductEl = document.getElementById('summary-product');
    const tableBody = document.getElementById('table-body');
    const sortToggle = document.getElementById('sort-toggle');
    const printButton = document.getElementById('print-pdf');
    const saveButton = document.getElementById('save-data');
    const resetButton = document.getElementById('reset-data');
    const downloadButton = document.getElementById('download-table');
    const printTitleEl = document.getElementById('print-title');
    const printLeftBody = document.getElementById('print-table-left');
    const printRightBody = document.getElementById('print-table-right');
    const modalOverlay = document.getElementById('modal-overlay');
    const verifyModal = document.getElementById('verify-modal');
    const editModal = document.getElementById('edit-modal');
    const verifyCodeInput = document.getElementById('verify-code');
    const verifyMessage = document.getElementById('verify-message');
    const verifySubmit = document.getElementById('verify-submit');
    const verifyClose = document.getElementById('verify-close');
    const verifyPrompt = document.getElementById('verify-prompt');
    const verifyYesEdit = document.getElementById('verify-yes-edit');
    const verifyNoEdit = document.getElementById('verify-no-edit');
    const editCodeDisplay = document.getElementById('edit-code-display');
    const editQtyInput = document.getElementById('edit-qty');
    const editCancel = document.getElementById('edit-cancel');
    const editSave = document.getElementById('edit-save');
    const inventoryTableBody = document.getElementById('inventory-table-body');
    const inventoryEmptyState = document.getElementById('inventory-empty');
    const importButton = document.getElementById('import-xls');
    const xlsInput = document.getElementById('xls-input');

    let dataEntries = [];
    let sortDirection = 'asc';
    let scanStart = null;
    let inventoryData = [];

    const STORAGE_KEY = 'controle-estoque-data';

    const getCurrentTitle = () => {
      const today = new Date();
      const dateStr = today.toLocaleDateString('pt-BR');
      return `${storeSelect.value}-${productSelect.value}-${dateStr}`;
    };

    const sanitizeCode = (value) => {
      return value.replace(/[^\w-]/gi, '').toUpperCase();
    };

    const focusAutoInput = () => {
      if (!manualPage.classList.contains('active')) {
        return;
      }
      setTimeout(() => autoInput.focus({ preventScroll: true }), 50);
    };

    const activatePage = (targetId) => {
      pages.forEach((page) => {
        page.classList.toggle('active', page.id === targetId);
      });
      navButtons.forEach((btn) => {
        btn.classList.toggle('active', btn.dataset.target === targetId);
      });
      if (targetId === 'manual-page') {
        focusAutoInput();
      }
    };

    navButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const target = button.dataset.target;
        if (!target) return;
        activatePage(target);
      });
    });

    const normalizeHeader = (value) => {
      if (value == null) return '';
      return value
        .toString()
        .trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    };

    const parseSaldoNumber = (value) => {
      if (value == null || value === '') return null;
      if (typeof value === 'number') return value;
      const normalized = value.toString().trim();
      if (!normalized) return null;
      const compact = normalized.replace(/\s+/g, '');
      const hasComma = compact.includes(',');
      const hasDot = compact.includes('.');
      let candidate = compact;
      if (hasComma && hasDot) {
        candidate = candidate.replace(/\./g, '').replace(',', '.');
      } else if (hasComma) {
        candidate = candidate.replace(',', '.');
      }
      const parsed = Number(candidate);
      if (!Number.isNaN(parsed)) {
        return parsed;
      }
      return null;
    };

    const formatInventoryNumber = (value) => {
      if (value == null || value === '') return '';
      const number = Number(value);
      if (Number.isNaN(number)) {
        return value.toString();
      }
      return new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 4
      }).format(number);
    };

    const updateStatusDot = (dot, entry) => {
      dot.className = 'status-dot';
      if (entry.saldoContabil == null) {
        dot.classList.add('status-dot--pending');
        dot.title = 'Saldo contábil inválido';
        return;
      }
      if (entry.saldoLoja == null) {
        dot.classList.add('status-dot--pending');
        dot.title = 'Aguardando conferência';
        return;
      }
      if (Math.abs(entry.saldoLoja - entry.saldoContabil) < 0.000001) {
        dot.classList.add('status-dot--ok');
        dot.title = 'Valores conferidos';
      } else {
        dot.classList.add('status-dot--alert');
        dot.title = 'Divergência encontrada';
      }
    };

    const renderInventoryTable = () => {
      if (!inventoryTableBody || !inventoryEmptyState) return;
      inventoryTableBody.innerHTML = '';
      if (!inventoryData.length) {
        inventoryEmptyState.classList.remove('hidden');
        return;
      }
      inventoryEmptyState.classList.add('hidden');
      inventoryData.forEach((entry, index) => {
        const row = document.createElement('tr');
        const codeCell = document.createElement('td');
        codeCell.textContent = entry.codigo;
        const productCell = document.createElement('td');
        productCell.textContent = entry.produto || '—';
        const saldoContabilCell = document.createElement('td');
        const saldoDisplay = entry.saldoContabil != null ? entry.saldoContabil : entry.saldoTexto;
        saldoContabilCell.textContent = formatInventoryNumber(saldoDisplay);
        const saldoLojaCell = document.createElement('td');
        const saldoInput = document.createElement('input');
        saldoInput.type = 'number';
        saldoInput.step = 'any';
        saldoInput.min = '0';
        saldoInput.className = 'saldo-loja-input';
        saldoInput.dataset.index = index.toString();
        saldoInput.value = entry.saldoLoja == null ? '' : entry.saldoLoja;
        saldoLojaCell.append(saldoInput);
        const statusCell = document.createElement('td');
        const statusDot = document.createElement('span');
        statusDot.className = 'status-dot';
        updateStatusDot(statusDot, entry);
        statusCell.append(statusDot);
        row.append(codeCell, productCell, saldoContabilCell, saldoLojaCell, statusCell);
        inventoryTableBody.append(row);
      });
    };

    const buildHeaderMap = (rows) => {
      for (let index = 0; index < rows.length; index += 1) {
        const row = rows[index];
        if (!row) continue;
        const map = {};
        row.forEach((cell, cellIndex) => {
          const normalized = normalizeHeader(cell);
          if (!normalized) return;
          if (map.codigo == null && normalized.startsWith('codigo')) {
            map.codigo = cellIndex;
          }
          if (map.produto == null && normalized === 'produto') {
            map.produto = cellIndex;
          }
          if (map.saldoContabil == null && normalized.startsWith('saldo contabil')) {
            map.saldoContabil = cellIndex;
          }
        });
        if (map.codigo != null && map.produto != null && map.saldoContabil != null) {
          return { headerIndex: index, map };
        }
      }
      return null;
    };

    const processWorkbook = (workbook) => {
      if (!workbook || !workbook.SheetNames || !workbook.SheetNames.length) {
        alert('O arquivo selecionado não possui dados reconhecíveis.');
        return;
      }
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      if (!worksheet) {
        alert('Não foi possível ler a planilha selecionada.');
        return;
      }
      const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true, defval: '' });
      if (!rows.length) {
        alert('A planilha selecionada está vazia.');
        inventoryData = [];
        renderInventoryTable();
        return;
      }
      const headerInfo = buildHeaderMap(rows);
      if (!headerInfo) {
        alert('Não foi possível localizar as colunas Código, Produto e Saldo Contábil.');
        inventoryData = [];
        renderInventoryTable();
        return;
      }
      const { headerIndex, map } = headerInfo;
      const imported = [];
      for (let rowIndex = headerIndex + 1; rowIndex < rows.length; rowIndex += 1) {
        const row = rows[rowIndex];
        if (!row) continue;
        const isEmpty = ['codigo', 'produto', 'saldoContabil'].every((key) => {
          const cell = row[map[key]];
          return cell == null || cell === '';
        });
        if (isEmpty) {
          if (imported.length) {
            break;
          }
          continue;
        }
        const codeRaw = row[map.codigo];
        const productRaw = row[map.produto];
        const saldoRaw = row[map.saldoContabil];
        const code = (codeRaw ?? '').toString().trim();
        const product = (productRaw ?? '').toString().trim();
        if (!code) {
          continue;
        }
        const parsedSaldo = parseSaldoNumber(saldoRaw);
        imported.push({
          codigo: code,
          produto: product,
          saldoContabil: parsedSaldo,
          saldoTexto: saldoRaw == null ? '' : saldoRaw.toString().trim(),
          saldoLoja: null
        });
      }
      if (!imported.length) {
        alert('Nenhum registro válido foi encontrado no arquivo selecionado.');
        inventoryData = [];
        renderInventoryTable();
        return;
      }
      inventoryData = imported;
      renderInventoryTable();
      activatePage('conferencia-page');
    };

    if (importButton && xlsInput) {
      importButton.addEventListener('click', () => {
        xlsInput.click();
      });

      xlsInput.addEventListener('change', (event) => {
        const { files } = event.target;
        if (!files || !files.length) return;
        const file = files[0];
        const reader = new FileReader();
        reader.onload = (loadEvent) => {
          try {
            const data = new Uint8Array(loadEvent.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            processWorkbook(workbook);
          } catch (error) {
            console.error('Erro ao importar XLS', error);
            alert('Não foi possível importar o arquivo selecionado.');
          }
        };
        reader.onerror = () => {
          console.error('Erro ao ler o arquivo selecionado.');
          alert('Não foi possível ler o arquivo selecionado.');
        };
        reader.readAsArrayBuffer(file);
        xlsInput.value = '';
      });
    }

    if (inventoryTableBody) {
      inventoryTableBody.addEventListener('input', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) return;
        if (!target.classList.contains('saldo-loja-input')) return;
        const index = Number(target.dataset.index);
        if (Number.isNaN(index) || !inventoryData[index]) return;
        const rawValue = target.value;
        if (rawValue === '') {
          inventoryData[index].saldoLoja = null;
        } else {
          const normalized = rawValue.replace(',', '.');
          const parsed = Number(normalized);
          if (Number.isNaN(parsed)) {
            return;
          }
          inventoryData[index].saldoLoja = parsed;
        }
        const row = target.closest('tr');
        const dot = row ? row.querySelector('.status-dot') : null;
        if (dot instanceof HTMLElement) {
          updateStatusDot(dot, inventoryData[index]);
        }
      });
    }

    renderInventoryTable();

    const updateSummary = () => {
      const total = dataEntries.reduce((sum, entry) => sum + entry.quantity, 0);
      totalQuantityEl.textContent = total.toString();
      summaryStoreEl.textContent = storeSelect.value;
      summaryProductEl.textContent = productSelect.value;
    };

    const updateLastCode = (code, durationMs, mode) => {
      if (!code) {
        lastCodeEl.textContent = '---';
        return;
      }
      if (mode === 'manual' || durationMs == null) {
        lastCodeEl.textContent = `${code} (Manual)`;
      } else {
        const seconds = (durationMs / 1000).toFixed(2);
        lastCodeEl.textContent = `${code} (Tempo: ${seconds}s)`;
      }
    };

    const renderTable = () => {
      const sorted = [...dataEntries].sort((a, b) => {
        const comparison = a.code.localeCompare(b.code, 'pt-BR', {
          numeric: true,
          sensitivity: 'base'
        });
        return sortDirection === 'asc' ? comparison : -comparison;
      });
      tableBody.innerHTML = '';
      sorted.forEach((entry) => {
        const row = document.createElement('tr');
        const codeCell = document.createElement('td');
        const qtyCell = document.createElement('td');
        const actionsCell = document.createElement('td');
        codeCell.textContent = entry.code;
        qtyCell.textContent = entry.quantity;
        actionsCell.className = 'table-actions';
        const editButton = document.createElement('button');
        editButton.className = 'table-action edit-action';
        editButton.textContent = 'Editar';
        editButton.dataset.code = entry.code;
        const deleteButton = document.createElement('button');
        deleteButton.className = 'table-action delete-action';
        deleteButton.textContent = 'Excluir';
        deleteButton.dataset.code = entry.code;
        actionsCell.append(editButton, deleteButton);
        row.append(codeCell, qtyCell, actionsCell);
        tableBody.append(row);
      });
      updateSummary();
    };

    const syncStorage = () => {
      const payload = {
        entries: dataEntries,
        store: storeSelect.value,
        product: productSelect.value,
        lastCode: lastCodeEl.textContent
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    };

    const loadStorage = () => {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (!stored) return;
      try {
        const payload = JSON.parse(stored);
        if (payload.entries && Array.isArray(payload.entries)) {
          dataEntries = payload.entries.map((item) => ({
            code: item.code,
            quantity: Number(item.quantity) || 0
          })).filter((item) => item.code && item.quantity > 0);
        }
        if (payload.store) {
          storeSelect.value = payload.store;
        }
        if (payload.product) {
          productSelect.value = payload.product;
        }
        renderTable();
        if (payload.lastCode) {
          lastCodeEl.textContent = payload.lastCode;
        }
      } catch (error) {
        console.error('Erro ao carregar dados salvos', error);
      }
    };

    const upsertEntry = (code, quantity) => {
      if (!code || quantity <= 0) return;
      const sanitized = sanitizeCode(code);
      if (!sanitized) return;
      const existing = dataEntries.find((item) => item.code === sanitized);
      if (existing) {
        existing.quantity += quantity;
      } else {
        dataEntries.push({ code: sanitized, quantity });
      }
      sortDirection = 'asc';
      sortToggle.textContent = 'Ordem ↑';
      renderTable();
      updateLastCode(sanitized, lastEntryDurationMs, lastEntryMode);
      lastEntryDurationMs = null;
      lastEntryMode = 'auto';
      syncStorage();
    };

    let lastEntryDurationMs = null;
    let lastEntryMode = 'auto';

    autoInput.addEventListener('keydown', (event) => {
      if (event.key === 'Tab') {
        event.preventDefault();
      }
      if ((event.ctrlKey || event.metaKey) && ['w', 'W', 'r', 'R'].includes(event.key)) {
        event.preventDefault();
      }
      if (event.key === 'F5' || event.key === 'F11' || (event.altKey && event.key === 'F4')) {
        event.preventDefault();
      }
      const allowedControlKeys = ['Backspace', 'Enter', 'Delete', 'ArrowLeft', 'ArrowRight'];
      const isAlphaNumeric = /[\w-]/.test(event.key);
      if (!isAlphaNumeric && !allowedControlKeys.includes(event.key)) {
        event.preventDefault();
      }
      if (!scanStart && isAlphaNumeric) {
        scanStart = performance.now();
      }
      if (event.key === 'Enter') {
        event.preventDefault();
        const sanitized = sanitizeCode(autoInput.value);
        if (sanitized) {
          const scanEnd = performance.now();
          lastEntryDurationMs = scanStart ? (scanEnd - scanStart) : 0;
          lastEntryMode = 'auto';
          upsertEntry(sanitized, 1);
        }
        autoInput.value = '';
        scanStart = null;
        focusAutoInput();
      }
    });

    autoInput.addEventListener('input', () => {
      const sanitized = sanitizeCode(autoInput.value);
      if (sanitized !== autoInput.value) {
        autoInput.value = sanitized;
      }
    });

    manualAddButton.addEventListener('click', () => {
      const code = sanitizeCode(manualCodeInput.value);
      const quantity = Number(manualQtyInput.value) || 0;
      if (!code) {
        alert('Informe um código válido.');
        return;
      }
      if (quantity <= 0) {
        alert('Informe uma quantidade válida.');
        return;
      }
      lastEntryDurationMs = null;
      lastEntryMode = 'manual';
      upsertEntry(code, quantity);
      manualCodeInput.value = '';
      manualQtyInput.value = '1';
      focusAutoInput();
    });

    manualCheckButton.addEventListener('click', () => {
      openVerifyModal();
    });

    manualCodeInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        manualAddButton.click();
      }
    });

    manualQtyInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        manualAddButton.click();
      }
    });

    storeSelect.addEventListener('change', () => {
      summaryStoreEl.textContent = storeSelect.value;
      syncStorage();
    });

    productSelect.addEventListener('change', () => {
      summaryProductEl.textContent = productSelect.value;
      syncStorage();
    });

    sortToggle.addEventListener('click', () => {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      sortToggle.textContent = sortDirection === 'asc' ? 'Ordem ↑' : 'Ordem ↓';
      renderTable();
    });

    let pendingVerifyCode = null;
    let currentEditingCode = null;

    const closeModal = () => {
      modalOverlay.classList.remove('active');
      verifyModal.classList.remove('active');
      editModal.classList.remove('active');
      resetVerifyModal();
      currentEditingCode = null;
      focusAutoInput();
    };

    const showModal = (modalElement) => {
      modalOverlay.classList.add('active');
      verifyModal.classList.remove('active');
      editModal.classList.remove('active');
      modalElement.classList.add('active');
    };

    const resetVerifyModal = () => {
      pendingVerifyCode = null;
      verifyMessage.textContent = '';
      verifyCodeInput.value = '';
      verifyPrompt.classList.add('hidden');
    };

    const openVerifyModal = () => {
      resetVerifyModal();
      showModal(verifyModal);
      setTimeout(() => verifyCodeInput.focus({ preventScroll: true }), 50);
    };

    const openEditModal = (code) => {
      const entry = dataEntries.find((item) => item.code === code);
      if (!entry) {
        alert('Item não encontrado.');
        return;
      }
      currentEditingCode = entry.code;
      editCodeDisplay.textContent = entry.code;
      editQtyInput.value = entry.quantity;
      showModal(editModal);
      setTimeout(() => editQtyInput.focus({ preventScroll: true }), 50);
    };

    verifySubmit.addEventListener('click', () => {
      const code = sanitizeCode(verifyCodeInput.value);
      if (!code) {
        verifyMessage.textContent = 'Informe um código válido.';
        verifyPrompt.classList.add('hidden');
        return;
      }
      const entry = dataEntries.find((item) => item.code === code);
      if (entry) {
        pendingVerifyCode = entry.code;
        verifyMessage.textContent = 'Produto já cadastrado. Gostaria de editá-lo?';
        verifyPrompt.classList.remove('hidden');
      } else {
        verifyMessage.textContent = 'Produto não cadastrado.';
        verifyPrompt.classList.add('hidden');
      }
    });

    verifyCodeInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        verifySubmit.click();
      }
    });

    verifyCodeInput.addEventListener('input', () => {
      const sanitized = sanitizeCode(verifyCodeInput.value);
      if (sanitized !== verifyCodeInput.value) {
        verifyCodeInput.value = sanitized;
      }
    });

    verifyClose.addEventListener('click', () => {
      closeModal();
    });

    verifyNoEdit.addEventListener('click', () => {
      closeModal();
    });

    verifyYesEdit.addEventListener('click', () => {
      if (pendingVerifyCode) {
        openEditModal(pendingVerifyCode);
      }
    });

    editCancel.addEventListener('click', () => {
      closeModal();
    });

    editSave.addEventListener('click', () => {
      const quantity = Number(editQtyInput.value) || 0;
      if (quantity <= 0) {
        alert('Informe uma quantidade válida.');
        return;
      }
      const entry = dataEntries.find((item) => item.code === currentEditingCode);
      if (!entry) {
        alert('Item não encontrado.');
        closeModal();
        return;
      }
      entry.quantity = quantity;
      renderTable();
      updateLastCode(entry.code, null, 'manual');
      syncStorage();
      closeModal();
    });

    modalOverlay.addEventListener('click', (event) => {
      if (event.target === modalOverlay) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeModal();
      }
    });

    tableBody.addEventListener('click', (event) => {
      const target = event.target;
      if (target instanceof HTMLElement) {
        if (target.classList.contains('edit-action')) {
          openEditModal(target.dataset.code);
        }
        if (target.classList.contains('delete-action')) {
          const code = target.dataset.code;
          const confirmDelete = confirm(`Deseja excluir o item "${code}"?`);
          if (!confirmDelete) return;
          dataEntries = dataEntries.filter((item) => item.code !== code);
          renderTable();
          if (!dataEntries.length) {
            updateLastCode(null, null, null);
          }
          syncStorage();
        }
      }
    });

    const preparePrintTables = () => {
      const sorted = [...dataEntries].sort((a, b) => a.code.localeCompare(b.code, 'pt-BR', {
        numeric: true,
        sensitivity: 'base'
      }));
      const midpoint = Math.ceil(sorted.length / 2);
      const left = sorted.slice(0, midpoint);
      const right = sorted.slice(midpoint);
      const fillTable = (tbody, items) => {
        tbody.innerHTML = '';
        items.forEach((entry) => {
          const row = document.createElement('tr');
          const codeCell = document.createElement('td');
          const qtyCell = document.createElement('td');
          codeCell.textContent = entry.code;
          qtyCell.textContent = entry.quantity;
          row.append(codeCell, qtyCell);
          tbody.append(row);
        });
      };
      fillTable(printLeftBody, left);
      fillTable(printRightBody, right);
      printTitleEl.textContent = getCurrentTitle();
    };

    printButton.addEventListener('click', () => {
      if (!dataEntries.length) {
        alert('Adicione registros antes de imprimir.');
        return;
      }
      preparePrintTables();
      window.print();
      focusAutoInput();
    });

    saveButton.addEventListener('click', () => {
      syncStorage();
      alert('Dados salvos com sucesso.');
      focusAutoInput();
    });

    resetButton.addEventListener('click', () => {
      const confirmReset = confirm('Deseja realmente resetar todos os dados?');
      if (!confirmReset) return;
      dataEntries = [];
      renderTable();
      updateLastCode(null, null, null);
      localStorage.removeItem(STORAGE_KEY);
      focusAutoInput();
    });

    const downloadCSV = () => {
      if (!dataEntries.length) {
        alert('Não há dados para baixar.');
        return;
      }
      const sorted = [...dataEntries].sort((a, b) => a.code.localeCompare(b.code, 'pt-BR', {
        numeric: true,
        sensitivity: 'base'
      }));
      const lines = [];
      const title = getCurrentTitle();
      lines.push(`"${title}"`);
      lines.push('Produto;Quantidade');
      sorted.forEach((entry) => {
        lines.push(`${entry.code};${entry.quantity}`);
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${title}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      focusAutoInput();
    };

    downloadButton.addEventListener('click', downloadCSV);

    document.addEventListener('keydown', (event) => {
      if ((event.ctrlKey || event.metaKey) && ['w', 'W', 'r', 'R'].includes(event.key)) {
        event.preventDefault();
      }
      if (event.key === 'F5' || (event.altKey && event.key === 'F4')) {
        event.preventDefault();
      }
    });

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        focusAutoInput();
      }
    });

    window.addEventListener('load', () => {
      loadStorage();
      focusAutoInput();
    });

    window.addEventListener('beforeunload', (event) => {
      if (dataEntries.length) {
        event.preventDefault();
        event.returnValue = '';
      }
    });
  </script>
</body>
</html>
