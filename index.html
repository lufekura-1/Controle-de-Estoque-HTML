<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Estoque</title>
  <style>
    :root {
      --bg-color: #f5f7fb;
      --chip-bg: #ffffff;
      --accent: #3f51b5;
      --accent-light: #5c6bc0;
      --text: #1f2933;
      --muted: #52606d;
      --border-radius: 18px;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    body {
      margin: 0;
      padding: 24px;
      background: linear-gradient(135deg, #e3eeff 0%, #f8f9ff 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .inventory-app {
      width: 100%;
      max-width: 1400px;
    }

    .top-menu {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--chip-bg);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 4px 16px;
      min-height: 40px;
      margin-bottom: 24px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .top-menu-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .top-menu-group:last-of-type {
      margin-left: auto;
    }

    .top-menu .button {
      padding: 8px 16px;
      font-size: 0.9rem;
      border-radius: 999px;
      height: 32px;
      box-shadow: none;
    }

    .top-menu .button:hover {
      box-shadow: 0 6px 12px rgba(63, 81, 181, 0.25);
    }

    .button--green {
      background: #22c55e;
    }

    .button--green:hover {
      box-shadow: 0 6px 12px rgba(34, 197, 94, 0.3);
    }

    .button--orange {
      background: #f97316;
    }

    .button--orange:hover {
      box-shadow: 0 6px 12px rgba(249, 115, 22, 0.3);
    }

    .inventory-page {
      width: 100%;
    }

    h1 {
      text-align: center;
      color: var(--accent);
      margin-bottom: 24px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(480px, 3fr) minmax(240px, 1fr);
      align-items: stretch;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto 32px auto;
    }

    #inventory-data-entry {
      grid-column: 1 / -1;
    }

    .summary-wrapper {
      max-width: 1200px;
      margin: 0 auto 24px auto;
    }

    .chip {
      background: var(--chip-bg);
      border-radius: var(--border-radius);
      padding: 16px 18px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .chip--compact {
      gap: 12px;
      padding: 14px 16px;
    }

    .chip-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .inventory-reminder {
      margin: 4px 0 12px;
      font-size: 0.85rem;
      color: var(--accent);
      background: rgba(63, 81, 181, 0.1);
      padding: 8px 12px;
      border-radius: 10px;
    }

    .inputs-row {
      display: grid;
      gap: 16px;
    }

    .inputs-row.double {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    label {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
      color: var(--muted);
      gap: 6px;
    }

    input[type="text"],
    input[type="number"],
    select {
      border: 1px solid #d1d5db;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 1rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
    }

    .button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .button.secondary {
      background: #e5e7eb;
      color: var(--text);
    }

    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(63, 81, 181, 0.25);
    }

    .button.secondary:hover {
      box-shadow: 0 8px 16px rgba(148, 163, 184, 0.25);
    }

    .button-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .button-stack {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .button-stack .button {
      width: 100%;
    }

    .manual-actions {
      display: flex;
      align-items: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(120px, 1fr));
      gap: 12px;
      align-items: stretch;
    }

    .stat-card {
      background: rgba(63, 81, 181, 0.07);
      border-radius: 14px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      justify-content: space-between;
    }

    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 1px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--accent-light);
      word-break: break-word;
    }

    .stat-card--action .stat-value-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .stat-action-button {
      background: rgba(63, 81, 181, 0.12);
      border: none;
      color: var(--accent);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.15s ease;
      white-space: nowrap;
    }

    .stat-action-button:hover {
      background: rgba(63, 81, 181, 0.2);
      transform: translateY(-1px);
    }

    .stat-card--highlight {
      background: var(--accent);
      color: white;
      box-shadow: 0 14px 28px rgba(63, 81, 181, 0.3);
    }

    .stat-card--highlight .stat-label,
    .stat-card--highlight .stat-value {
      color: white;
    }

    .stat-card--highlight .stat-value {
      font-size: 1.15rem;
      letter-spacing: 0.5px;
    }

    .button.ghost {
      background: rgba(63, 81, 181, 0.1);
      color: var(--accent);
    }

    .button.ghost:hover {
      box-shadow: 0 8px 16px rgba(63, 81, 181, 0.2);
    }

    .inventory-note {
      background: rgba(63, 81, 181, 0.08);
      border-radius: 12px;
      padding: 12px 14px;
    }

    .inventory-instructions {
      margin: 0;
      color: var(--muted);
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .hidden-file-input {
      display: none;
    }

    .table-section {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .table-title {
      font-weight: 600;
      color: var(--muted);
      padding: 0 4px;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 18px;
      box-shadow: var(--shadow);
      background: var(--chip-bg);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 320px;
      font-size: 0.95rem;
    }

    thead {
      background: var(--accent);
      color: white;
    }

    th,
    td {
      padding: 10px 12px;
      text-align: left;
    }

    tbody tr:nth-child(even) {
      background: rgba(63, 81, 181, 0.08);
    }

    .saldo-loja-input {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 0.95rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    .saldo-loja-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
    }

    .status-dot {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      display: inline-block;
      background: #cbd5f5;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.6);
    }

    .status-dot--ok {
      background: #22c55e;
    }

    .status-dot--alert {
      background: #ef4444;
    }

    .status-dot--pending {
      background: #9ca3af;
    }

    .empty-state {
      margin-top: 16px;
      text-align: center;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 1000;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.22);
      max-width: 520px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 20px 12px 20px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.05rem;
      color: var(--accent);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      line-height: 1;
      cursor: pointer;
      color: var(--muted);
      padding: 4px 8px;
    }

    .modal-content {
      padding: 16px 20px 20px 20px;
      overflow-y: auto;
    }

    .modal-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: none;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .modal-list.active {
      display: block;
    }

    .modal-list li + li {
      margin-top: 6px;
    }

    .hidden {
      display: none !important;
    }

    .print-surface {
      display: none;
    }

    .print-surface.print-ready {
      display: block;
    }

    #inventory-report-area {
      background: white;
      padding: 20px;
      font-size: 0.9rem;
    }

    #inventory-report-area table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 18px;
    }

    #inventory-report-area th,
    #inventory-report-area td {
      border: 1px solid rgba(31, 41, 51, 0.15);
      padding: 6px 8px;
      text-align: left;
    }

    #inventory-report-area th {
      background: rgba(63, 81, 181, 0.12);
      color: var(--accent);
    }

    .report-section {
      margin-top: 24px;
    }

    .report-section h3 {
      margin: 0 0 12px 0;
      color: var(--accent);
      font-size: 1rem;
    }

    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
    }

    @media (max-width: 960px) {
      body {
        padding: 16px;
      }

      .layout-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .chip {
        padding: 16px;
      }
    }

    @media print {
      body {
        padding: 0;
        background: white;
      }

      .inventory-app > :not(#inventory-report-area) {
        display: none !important;
      }

      #inventory-report-area.print-ready {
        display: block !important;
        width: 100%;
        padding: 24px;
        box-sizing: border-box;
        background: white;
      }
    }
  </style>
</head>
<body>
  <main class="inventory-app">
    <nav class="top-menu" aria-label="Ações rápidas">
      <div class="top-menu-group">
        <button class="button button--green" id="inventory-print-report">Imprimir Relatório</button>
        <button class="button button--green" id="inventory-save">Salvar Conferência</button>
        <button class="button button--green" id="inventory-export-data">Exportar CSV</button>
      </div>
      <div class="top-menu-group">
        <button class="button" id="import-xls">Importar XLS</button>
        <button class="button button--orange" id="inventory-reset">Resetar Dados</button>
      </div>
      <input type="file" id="xls-input" accept=".xls,.xlsx" class="hidden-file-input" />
    </nav>
    <section class="inventory-page" id="conferencia-page">
      <h1>Conferência de Estoque</h1>

      <div class="layout-grid">
        <div class="chip" id="inventory-data-entry">
          <div class="chip-section-title">Inserção de Dados</div>
          <p class="inventory-reminder">Selecione a loja e o produto antes de iniciar o cadastro ou a importação.</p>
          <div class="inputs-row">
            <label for="inventory-auto-code">
              Campo Automático (Leitor)
              <input
                id="inventory-auto-code"
                data-role="auto-input"
                type="text"
                autocomplete="off"
                spellcheck="false"
                placeholder="Aproxime o leitor aqui"
              />
            </label>
          </div>
          <div class="inputs-row double">
            <label for="inventory-manual-code">
              Código Manual
              <input id="inventory-manual-code" type="text" placeholder="Informe o código" />
            </label>
            <label for="inventory-manual-qty">
              Quantidade
              <input id="inventory-manual-qty" type="number" min="1" value="1" />
            </label>
            <div class="manual-actions">
              <button class="button" id="inventory-manual-add">Adicionar</button>
            </div>
          </div>
          <div class="inputs-row double">
            <label for="inventory-store-select">
              Loja
              <select id="inventory-store-select">
                <option value="">Selecione a loja</option>
                <option value="Jorel Chicuta">Jorel Chicuta</option>
                <option value="Jorel Avenida">Jorel Avenida</option>
                <option value="Exótica">Exótica</option>
              </select>
            </label>
            <label for="inventory-product-select">
              Produto
              <select id="inventory-product-select">
                <option value="">Selecione o produto</option>
                <option value="Anel">Anel</option>
                <option value="Brinco">Brinco</option>
                <option value="Pingente">Pingente</option>
                <option value="Corrente">Corrente</option>
                <option value="Pulseira">Pulseira</option>
                <option value="Aliança">Aliança</option>
                <option value="Relógio">Relógio</option>
                <option value="Armação">Armação</option>
                <option value="Solar">Solar</option>
                <option value="Outro">Outro</option>
              </select>
            </label>
          </div>
          <div class="inventory-note">
            <p class="inventory-instructions">
              Importe um arquivo contendo as colunas Código, Produto e Saldo Contábil. Os valores inseridos manualmente
              serão somados ao Saldo em Loja para conferência.
            </p>
          </div>
        </div>

      </div>

      <div class="summary-wrapper">
        <div class="chip chip--compact" id="inventory-summary">
          <div class="chip-section-title">Resumo Atual</div>
          <div class="stats-grid">
            <div class="stat-card">
              <span class="stat-label">Importados</span>
              <span class="stat-value" id="inventory-total-imported">0</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Cadastrados</span>
              <span class="stat-value" id="inventory-total-registered">0</span>
            </div>
            <div class="stat-card stat-card--action">
              <span class="stat-label">Não Cadastrado</span>
              <div class="stat-value-row">
                <span class="stat-value" id="inventory-non-registered-count">0</span>
                <button
                  class="stat-action-button"
                  type="button"
                  data-breakdown-target="nonRegistered"
                  aria-label="Ver códigos não cadastrados"
                >
                  Ver
                </button>
              </div>
            </div>
            <div class="stat-card stat-card--action">
              <span class="stat-label">Faltando</span>
              <div class="stat-value-row">
                <span class="stat-value" id="inventory-missing-count">0</span>
                <button
                  class="stat-action-button"
                  type="button"
                  data-breakdown-target="missing"
                  aria-label="Ver códigos faltando"
                >
                  Ver
                </button>
              </div>
            </div>
            <div class="stat-card stat-card--action">
              <span class="stat-label">Negativos</span>
              <div class="stat-value-row">
                <span class="stat-value" id="inventory-negative-count">0</span>
                <button
                  class="stat-action-button"
                  type="button"
                  data-breakdown-target="negative"
                  aria-label="Ver códigos negativos"
                >
                  Ver
                </button>
              </div>
            </div>
            <div class="stat-card stat-card--action">
              <span class="stat-label">Incorretos</span>
              <div class="stat-value-row">
                <span class="stat-value" id="inventory-incorrect-count">0</span>
                <button
                  class="stat-action-button"
                  type="button"
                  data-breakdown-target="incorrect"
                  aria-label="Ver códigos incorretos"
                >
                  Ver
                </button>
              </div>
            </div>
            <div class="stat-card stat-card--highlight">
              <span class="stat-label">Último Código</span>
              <span class="stat-value" id="inventory-last-code">---</span>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-overlay" id="inventory-breakdown-modal" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="inventory-modal-title" tabindex="-1">
          <div class="modal-header">
            <h3 id="inventory-modal-title">Detalhes</h3>
            <button type="button" class="modal-close" id="inventory-modal-close" aria-label="Fechar modal">&times;</button>
          </div>
          <div class="modal-content">
            <ul class="modal-list" id="inventory-incorrect-list"></ul>
            <ul class="modal-list" id="inventory-non-registered-list"></ul>
            <ul class="modal-list" id="inventory-missing-list"></ul>
            <ul class="modal-list" id="inventory-negative-list"></ul>
          </div>
        </div>
      </div>

      <div class="table-section">
        <div class="table-title">Saldos Conferidos</div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Código</th>
                <th>Produto</th>
                <th>Saldo Contábil</th>
                <th>Saldo em Loja</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="inventory-table-body"></tbody>
          </table>
        </div>
        <div class="empty-state" id="inventory-empty">Importe um arquivo XLS ou adicione códigos para iniciar a conferência.</div>
      </div>

    </section>

    <div id="inventory-report-area" class="print-surface">
      <h2 id="inventory-report-title"></h2>
      <table>
        <thead>
          <tr>
            <th>Resumo</th>
            <th>Valor</th>
          </tr>
        </thead>
        <tbody id="inventory-report-overview"></tbody>
      </table>

      <div class="report-section">
        <h3>Códigos Incorretos</h3>
        <table>
          <thead>
            <tr>
              <th>Código</th>
              <th>Saldo Contábil</th>
              <th>Saldo em Loja</th>
            </tr>
          </thead>
          <tbody id="inventory-report-incorrect"></tbody>
        </table>
      </div>

      <div class="report-section">
        <h3>Não Cadastrados</h3>
        <table>
          <thead>
            <tr>
              <th>Código</th>
              <th>Quantidade</th>
            </tr>
          </thead>
          <tbody id="inventory-report-non-registered"></tbody>
        </table>
      </div>

      <div class="report-section">
        <h3>Códigos Faltando</h3>
        <table>
          <thead>
            <tr>
              <th>Código</th>
              <th>Esperado</th>
              <th>Encontrado</th>
            </tr>
          </thead>
          <tbody id="inventory-report-missing"></tbody>
        </table>
      </div>

      <div class="report-section">
        <h3>Códigos Negativos</h3>
        <table>
          <thead>
            <tr>
              <th>Código</th>
              <th>Saldo Contábil</th>
            </tr>
          </thead>
          <tbody id="inventory-report-negative"></tbody>
        </table>
      </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const inventoryAutoInput = document.getElementById('inventory-auto-code');
    const inventoryManualCodeInput = document.getElementById('inventory-manual-code');
    const inventoryManualQtyInput = document.getElementById('inventory-manual-qty');
    const inventoryManualAddButton = document.getElementById('inventory-manual-add');
    const inventoryResetButton = document.getElementById('inventory-reset');
    const inventoryStoreSelect = document.getElementById('inventory-store-select');
    const inventoryProductSelect = document.getElementById('inventory-product-select');
    const inventoryTotals = {
      imported: document.getElementById('inventory-total-imported'),
      registered: document.getElementById('inventory-total-registered'),
      nonRegistered: document.getElementById('inventory-non-registered-count'),
      missing: document.getElementById('inventory-missing-count'),
      negatives: document.getElementById('inventory-negative-count'),
      incorrect: document.getElementById('inventory-incorrect-count'),
      lastCode: document.getElementById('inventory-last-code')
    };
    const inventoryBreakdownLists = {
      incorrect: document.getElementById('inventory-incorrect-list'),
      nonRegistered: document.getElementById('inventory-non-registered-list'),
      missing: document.getElementById('inventory-missing-list'),
      negative: document.getElementById('inventory-negative-list')
    };
    const breakdownModal = document.getElementById('inventory-breakdown-modal');
    const breakdownModalTitle = document.getElementById('inventory-modal-title');
    const breakdownModalClose = document.getElementById('inventory-modal-close');
    const breakdownModalCard = breakdownModal ? breakdownModal.querySelector('.modal-card') : null;
    const breakdownTitles = {
      incorrect: 'Códigos Incorretos',
      nonRegistered: 'Códigos não cadastrados',
      missing: 'Códigos Faltando',
      negative: 'Códigos Negativos'
    };
    let lastBreakdownTrigger = null;
    const breakdownTriggerButtons = document.querySelectorAll('[data-breakdown-target]');
    const inventoryTableBody = document.getElementById('inventory-table-body');
    const inventoryEmptyState = document.getElementById('inventory-empty');
    const importButton = document.getElementById('import-xls');
    const xlsInput = document.getElementById('xls-input');
    const inventoryPrintButton = document.getElementById('inventory-print-report');
    const inventorySaveButton = document.getElementById('inventory-save');
    const inventoryExportButton = document.getElementById('inventory-export-data');
    const inventoryReportArea = document.getElementById('inventory-report-area');
    const inventoryReportTitle = document.getElementById('inventory-report-title');
    const inventoryReportOverview = document.getElementById('inventory-report-overview');
    const inventoryReportIncorrect = document.getElementById('inventory-report-incorrect');
    const inventoryReportNonRegistered = document.getElementById('inventory-report-non-registered');
    const inventoryReportMissing = document.getElementById('inventory-report-missing');
    const inventoryReportNegative = document.getElementById('inventory-report-negative');

    let inventoryData = [];
    let currentPrintSurface = null;
    let lastEntryDurationMs = null;
    let lastEntryMode = 'auto';

    const STORAGE_KEY = 'controle-estoque-inventory';

    const sanitizeCode = (value) => {
      if (typeof value !== 'string') {
        return '';
      }
      return value.replace(/[^\w-]/gi, '').toUpperCase();
    };

    const focusAutoInput = () => {
      if (inventoryAutoInput instanceof HTMLInputElement) {
        setTimeout(() => inventoryAutoInput.focus({ preventScroll: true }), 50);
      }
    };

    const getStoreValue = () =>
      inventoryStoreSelect instanceof HTMLSelectElement ? inventoryStoreSelect.value : '';
    const getProductValue = () =>
      inventoryProductSelect instanceof HTMLSelectElement ? inventoryProductSelect.value : '';

    const isContextSelected = () => getStoreValue() !== '' && getProductValue() !== '';

    const focusMissingContext = () => {
      if (!(inventoryStoreSelect instanceof HTMLSelectElement) || !(inventoryProductSelect instanceof HTMLSelectElement)) {
        return;
      }
      if (inventoryStoreSelect.value === '') {
        inventoryStoreSelect.focus();
        return;
      }
      if (inventoryProductSelect.value === '') {
        inventoryProductSelect.focus();
      }
    };

    const ensureContextSelected = () => {
      if (isContextSelected()) {
        return true;
      }
      alert('Selecione a loja e o produto antes de continuar.');
      focusMissingContext();
      return false;
    };

    const resetContextSelection = () => {
      if (inventoryStoreSelect instanceof HTMLSelectElement) {
        inventoryStoreSelect.value = '';
      }
      if (inventoryProductSelect instanceof HTMLSelectElement) {
        inventoryProductSelect.value = '';
      }
    };

    const normalizeHeader = (value) => {
      if (value == null) return '';
      return value
        .toString()
        .trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    };

    const parseSaldoNumber = (value) => {
      if (value == null || value === '') return null;
      if (typeof value === 'number') return value;
      const normalized = value.toString().trim();
      if (!normalized) return null;
      const compact = normalized.replace(/\s+/g, '');
      const hasComma = compact.includes(',');
      const hasDot = compact.includes('.');
      let candidate = compact;
      if (hasComma && hasDot) {
        candidate = candidate.replace(/\./g, '').replace(',', '.');
      } else if (hasComma) {
        candidate = candidate.replace(',', '.');
      }
      const parsed = Number(candidate);
      if (!Number.isNaN(parsed)) {
        return parsed;
      }
      return null;
    };

    const formatInventoryNumber = (value) => {
      if (value == null || value === '') return '0';
      const number = Number(value);
      if (Number.isNaN(number)) {
        return value.toString();
      }
      return new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 4
      }).format(number);
    };

    const displayNumber = (value) => {
      if (value == null || value === '') {
        return '—';
      }
      return formatInventoryNumber(value);
    };

    const fillList = (element, items, formatter) => {
      if (!element) return;
      element.innerHTML = '';
      if (!items.length) {
        const emptyItem = document.createElement('li');
        emptyItem.textContent = 'Nenhum registro.';
        element.append(emptyItem);
        return;
      }
      items.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = formatter(item);
        element.append(li);
      });
    };

    const setActiveBreakdownList = (type) => {
      Object.entries(inventoryBreakdownLists).forEach(([key, element]) => {
        if (!element) return;
        element.classList.toggle('active', key === type);
      });
    };

    const openBreakdownModal = (type, trigger) => {
      if (!breakdownModal) return;
      const normalizedType = Object.prototype.hasOwnProperty.call(inventoryBreakdownLists, type)
        ? type
        : 'incorrect';
      lastBreakdownTrigger = trigger || null;
      if (breakdownModalTitle) {
        breakdownModalTitle.textContent = breakdownTitles[normalizedType] || 'Detalhes';
      }
      setActiveBreakdownList(normalizedType);
      breakdownModal.classList.add('open');
      breakdownModal.setAttribute('aria-hidden', 'false');
      requestAnimationFrame(() => {
        if (breakdownModalCard instanceof HTMLElement) {
          breakdownModalCard.focus();
        }
      });
    };

    const closeBreakdownModal = () => {
      if (!breakdownModal) return;
      breakdownModal.classList.remove('open');
      breakdownModal.setAttribute('aria-hidden', 'true');
      if (lastBreakdownTrigger instanceof HTMLElement) {
        lastBreakdownTrigger.focus();
      }
      lastBreakdownTrigger = null;
    };

    breakdownTriggerButtons.forEach((button) => {
      if (!(button instanceof HTMLElement)) return;
      button.addEventListener('click', () => {
        const { breakdownTarget } = button.dataset;
        openBreakdownModal(breakdownTarget, button);
      });
    });

    if (breakdownModalClose) {
      breakdownModalClose.addEventListener('click', () => {
        closeBreakdownModal();
      });
    }

    if (breakdownModal) {
      breakdownModal.addEventListener('click', (event) => {
        if (event.target === breakdownModal) {
          closeBreakdownModal();
        }
      });
    }

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && breakdownModal && breakdownModal.classList.contains('open')) {
        closeBreakdownModal();
      }
    });

    const computeInventoryMetrics = () => {
      const totals = { imported: 0, registered: 0, negatives: 0 };
      let compared = 0;
      let incorrect = 0;
      const breakdown = {
        incorrect: [],
        nonRegistered: [],
        missing: [],
        negative: []
      };

      inventoryData.forEach((entry) => {
        const contabil = typeof entry.saldoContabil === 'number' ? entry.saldoContabil : null;
        const loja = typeof entry.saldoLoja === 'number' ? entry.saldoLoja : null;

        if (contabil != null) {
          totals.imported += contabil;
          if (contabil < 0) {
            totals.negatives += 1;
            breakdown.negative.push({ code: entry.codigo, saldoContabil: contabil });
          }
        }

        if (loja != null) {
          totals.registered += loja;
        }

        if (contabil != null && loja != null) {
          compared += 1;
          if (Math.abs(contabil - loja) >= 0.000001) {
            incorrect += 1;
            breakdown.incorrect.push({ code: entry.codigo, saldoContabil: contabil, saldoLoja: loja });
            if (loja < contabil) {
              breakdown.missing.push({ code: entry.codigo, esperado: contabil, encontrado: loja });
            }
          }
        } else if (contabil != null && loja == null) {
          breakdown.missing.push({ code: entry.codigo, esperado: contabil, encontrado: null });
        }

        if (contabil == null && loja != null) {
          breakdown.nonRegistered.push({ code: entry.codigo, quantidade: loja });
        }
      });

      const matchPercentage = compared === 0 ? 0 : ((compared - incorrect) / compared) * 100;

      return {
        totals,
        counters: { compared, incorrect, matchPercentage },
        breakdown
      };
    };

    const updateInventorySummary = () => {
      const metrics = computeInventoryMetrics();
      const { totals, breakdown } = metrics;

      inventoryTotals.imported.textContent = formatInventoryNumber(totals.imported);
      inventoryTotals.registered.textContent = formatInventoryNumber(totals.registered);
      inventoryTotals.negatives.textContent = breakdown.negative.length.toString();
      inventoryTotals.incorrect.textContent = breakdown.incorrect.length.toString();
      inventoryTotals.nonRegistered.textContent = breakdown.nonRegistered.length.toString();
      inventoryTotals.missing.textContent = breakdown.missing.length.toString();

      fillList(
        inventoryBreakdownLists.incorrect,
        breakdown.incorrect,
        (item) => `${item.code} • Contábil: ${displayNumber(item.saldoContabil)} | Loja: ${displayNumber(item.saldoLoja)}`
      );
      fillList(
        inventoryBreakdownLists.nonRegistered,
        breakdown.nonRegistered,
        (item) => `${item.code} • Quantidade: ${displayNumber(item.quantidade)}`
      );
      fillList(
        inventoryBreakdownLists.missing,
        breakdown.missing,
        (item) => `${item.code} • Esperado: ${displayNumber(item.esperado)} | Encontrado: ${displayNumber(item.encontrado)}`
      );
      fillList(
        inventoryBreakdownLists.negative,
        breakdown.negative,
        (item) => `${item.code} • Saldo: ${displayNumber(item.saldoContabil)}`
      );
    };
    const updateStatusDot = (dot, entry) => {
      dot.className = 'status-dot';
      if (entry.saldoContabil == null) {
        dot.classList.add('status-dot--pending');
        dot.title = 'Sem saldo contábil importado';
        return;
      }
      if (entry.saldoLoja == null) {
        dot.classList.add('status-dot--pending');
        dot.title = 'Aguardando conferência';
        return;
      }
      if (Math.abs(entry.saldoLoja - entry.saldoContabil) < 0.000001) {
        dot.classList.add('status-dot--ok');
        dot.title = 'Valores conferidos';
      } else {
        dot.classList.add('status-dot--alert');
        dot.title = 'Divergência encontrada';
      }
    };

    const renderInventoryTable = () => {
      if (!inventoryTableBody || !inventoryEmptyState) return;
      inventoryTableBody.innerHTML = '';
      if (!inventoryData.length) {
        inventoryEmptyState.classList.remove('hidden');
        updateInventorySummary();
        return;
      }
      inventoryEmptyState.classList.add('hidden');
      inventoryData.forEach((entry) => {
        const row = document.createElement('tr');
        const codeCell = document.createElement('td');
        codeCell.textContent = entry.codigo;
        const productCell = document.createElement('td');
        productCell.textContent = entry.produto || '—';
        const saldoContabilCell = document.createElement('td');
        const saldoDisplay = entry.saldoContabil != null ? entry.saldoContabil : entry.saldoTexto;
        saldoContabilCell.textContent = saldoDisplay != null && saldoDisplay !== '' ? formatInventoryNumber(saldoDisplay) : '—';
        const saldoLojaCell = document.createElement('td');
        const saldoInput = document.createElement('input');
        saldoInput.type = 'number';
        saldoInput.step = 'any';
        saldoInput.min = '0';
        saldoInput.className = 'saldo-loja-input';
        saldoInput.dataset.code = entry.codigo;
        saldoInput.value = entry.saldoLoja == null ? '' : entry.saldoLoja;
        saldoLojaCell.append(saldoInput);
        const statusCell = document.createElement('td');
        const statusDot = document.createElement('span');
        statusDot.className = 'status-dot';
        updateStatusDot(statusDot, entry);
        statusCell.append(statusDot);
        row.append(codeCell, productCell, saldoContabilCell, saldoLojaCell, statusCell);
        inventoryTableBody.append(row);
      });
      updateInventorySummary();
    };

    const syncStorage = () => {
      const payload = {
        inventory: inventoryData,
        store: getStoreValue(),
        product: getProductValue(),
        lastCode: inventoryTotals.lastCode.textContent
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    };

    const loadStorage = () => {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (!stored) return;
      try {
        const payload = JSON.parse(stored);
        if (payload.inventory && Array.isArray(payload.inventory)) {
          inventoryData = payload.inventory
            .map((item) => ({
              codigo: sanitizeCode(item.codigo || ''),
              produto: item.produto || '',
              saldoContabil: typeof item.saldoContabil === 'number' ? item.saldoContabil : parseSaldoNumber(item.saldoContabil),
              saldoTexto: item.saldoTexto || '',
              saldoLoja:
                item.saldoLoja == null
                  ? null
                  : typeof item.saldoLoja === 'number'
                  ? item.saldoLoja
                  : parseSaldoNumber(item.saldoLoja),
              manualOnly: Boolean(item.manualOnly) || item.saldoContabil == null
            }))
            .filter((item) => item.codigo);
        }
        if (inventoryStoreSelect instanceof HTMLSelectElement) {
          const hasStoreOption = Array.from(inventoryStoreSelect.options).some(
            (option) => option.value === payload.store
          );
          inventoryStoreSelect.value = hasStoreOption && payload.store ? payload.store : '';
        }
        if (inventoryProductSelect instanceof HTMLSelectElement) {
          const hasProductOption = Array.from(inventoryProductSelect.options).some(
            (option) => option.value === payload.product
          );
          inventoryProductSelect.value = hasProductOption && payload.product ? payload.product : '';
        }
        if (payload.lastCode) {
          inventoryTotals.lastCode.textContent = payload.lastCode;
        }
      } catch (error) {
        console.error('Erro ao carregar dados salvos', error);
      }
    };

    const updateLastCode = (code, durationMs, mode) => {
      if (!code) {
        inventoryTotals.lastCode.textContent = '---';
        return;
      }
      if (mode === 'manual' || durationMs == null) {
        inventoryTotals.lastCode.textContent = `${code} (Manual)`;
      } else {
        const seconds = (durationMs / 1000).toFixed(2);
        inventoryTotals.lastCode.textContent = `${code} (Tempo: ${seconds}s)`;
      }
    };

    const applyQuantityToInventory = (code, quantity) => {
      const sanitized = sanitizeCode(code);
      if (!sanitized || quantity <= 0) return;
      let entry = inventoryData.find((item) => item.codigo === sanitized);
      if (entry) {
        const previous = entry.saldoLoja == null ? 0 : entry.saldoLoja;
        entry.saldoLoja = previous + quantity;
        if (entry.manualOnly && entry.saldoContabil != null) {
          entry.manualOnly = false;
        }
      } else {
        entry = {
          codigo: sanitized,
          produto: '',
          saldoContabil: null,
          saldoTexto: '',
          saldoLoja: quantity,
          manualOnly: true
        };
        inventoryData.push(entry);
      }
      renderInventoryTable();
      syncStorage();
    };

    if (inventoryAutoInput) {
      let scanStartTime = null;
      inventoryAutoInput.addEventListener('keydown', (event) => {
        if (event.key === 'Tab') {
          event.preventDefault();
        }
        if ((event.ctrlKey || event.metaKey) && ['w', 'W', 'r', 'R'].includes(event.key)) {
          event.preventDefault();
        }
        if (event.key === 'F5' || event.key === 'F11' || (event.altKey && event.key === 'F4')) {
          event.preventDefault();
        }
        const allowedControlKeys = ['Backspace', 'Enter', 'Delete', 'ArrowLeft', 'ArrowRight'];
        const isAlphaNumeric = /[\w-]/.test(event.key);
        if (!isAlphaNumeric && !allowedControlKeys.includes(event.key)) {
          event.preventDefault();
        }
        if (scanStartTime == null && isAlphaNumeric) {
          scanStartTime = performance.now();
        }
        if (event.key === 'Enter') {
          event.preventDefault();
          const sanitized = sanitizeCode(inventoryAutoInput.value);
          if (sanitized) {
            if (!ensureContextSelected()) {
              inventoryAutoInput.value = '';
              scanStartTime = null;
              return;
            }
            const scanEnd = performance.now();
            lastEntryDurationMs = scanStartTime ? scanEnd - scanStartTime : 0;
            lastEntryMode = 'auto';
            applyQuantityToInventory(sanitized, 1);
            updateLastCode(sanitized, lastEntryDurationMs, lastEntryMode);
          }
          inventoryAutoInput.value = '';
          scanStartTime = null;
          if (isContextSelected()) {
            focusAutoInput();
          }
        }
      });

      inventoryAutoInput.addEventListener('input', () => {
        const sanitized = sanitizeCode(inventoryAutoInput.value);
        if (sanitized !== inventoryAutoInput.value) {
          inventoryAutoInput.value = sanitized;
        }
      });
    }

    if (inventoryManualCodeInput) {
      inventoryManualCodeInput.addEventListener('input', () => {
        const sanitized = sanitizeCode(inventoryManualCodeInput.value);
        if (sanitized !== inventoryManualCodeInput.value) {
          inventoryManualCodeInput.value = sanitized;
        }
      });
      inventoryManualCodeInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          if (inventoryManualAddButton) {
            inventoryManualAddButton.click();
          }
        }
      });
    }

    if (inventoryManualQtyInput) {
      inventoryManualQtyInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          if (inventoryManualAddButton) {
            inventoryManualAddButton.click();
          }
        }
      });
    }

    if (inventoryManualAddButton) {
      inventoryManualAddButton.addEventListener('click', () => {
        if (!ensureContextSelected()) {
          return;
        }
        const code = sanitizeCode(inventoryManualCodeInput.value);
        const quantity = Number(inventoryManualQtyInput.value) || 0;
        if (!code) {
          alert('Informe um código válido.');
          return;
        }
        if (quantity <= 0) {
          alert('Informe uma quantidade válida.');
          return;
        }
        lastEntryDurationMs = null;
        lastEntryMode = 'manual';
        applyQuantityToInventory(code, quantity);
        updateLastCode(code, lastEntryDurationMs, lastEntryMode);
        inventoryManualCodeInput.value = '';
        inventoryManualQtyInput.value = '1';
        focusAutoInput();
      });
    }

    if (inventoryResetButton) {
      inventoryResetButton.addEventListener('click', () => {
        const confirmReset = confirm('Deseja realmente resetar todos os dados? Esta ação removerá importações e lançamentos.');
        if (!confirmReset) return;
        inventoryData = [];
        inventoryTotals.lastCode.textContent = '---';
        resetContextSelection();
        localStorage.removeItem(STORAGE_KEY);
        renderInventoryTable();
        updateInventorySummary();
        inventoryEmptyState.classList.remove('hidden');
        alert('Selecione a loja e o produto antes de iniciar um novo cadastro ou importação.');
        focusMissingContext();
      });
    }

    inventoryStoreSelect.addEventListener('change', () => {
      syncStorage();
    });

    inventoryProductSelect.addEventListener('change', () => {
      syncStorage();
    });

    if (inventoryTableBody) {
      inventoryTableBody.addEventListener('input', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) return;
        if (!target.classList.contains('saldo-loja-input')) return;
        const code = target.dataset.code;
        if (!code) return;
        const entry = inventoryData.find((item) => item.codigo === code);
        if (!entry) return;
        const rawValue = target.value;
        if (rawValue === '') {
          entry.saldoLoja = null;
        } else {
          const normalized = rawValue.replace(',', '.');
          const parsed = Number(normalized);
          if (Number.isNaN(parsed)) {
            return;
          }
          entry.saldoLoja = parsed;
        }
        const row = target.closest('tr');
        const dot = row ? row.querySelector('.status-dot') : null;
        if (dot instanceof HTMLElement) {
          updateStatusDot(dot, entry);
        }
        updateInventorySummary();
        syncStorage();
      });
    }
    const setPrintSurface = (element) => {
      if (!element) return;
      if (currentPrintSurface) {
        currentPrintSurface.classList.remove('print-ready');
      }
      currentPrintSurface = element;
      currentPrintSurface.classList.add('print-ready');
    };

    const resetPrintSurface = () => {
      if (currentPrintSurface) {
        currentPrintSurface.classList.remove('print-ready');
        currentPrintSurface = null;
      }
    };

    const buildInventoryReport = () => {
      if (
        !inventoryReportArea ||
        !inventoryReportTitle ||
        !inventoryReportOverview ||
        !inventoryReportIncorrect ||
        !inventoryReportNonRegistered ||
        !inventoryReportMissing ||
        !inventoryReportNegative
      ) {
        return false;
      }
      const metrics = computeInventoryMetrics();
      const { totals, breakdown } = metrics;
      const today = new Date().toLocaleDateString('pt-BR');
      inventoryReportTitle.textContent = `${getStoreValue()} - ${today} - ${getProductValue()}`;

      const overviewRows = [
        { label: 'Quantidade Importada', value: formatInventoryNumber(totals.imported) },
        { label: 'Quantidade Cadastrada', value: formatInventoryNumber(totals.registered) },
        { label: 'Códigos Negativos', value: breakdown.negative.length.toString() },
        { label: 'Não Cadastrado', value: breakdown.nonRegistered.length.toString() },
        { label: 'Faltando', value: breakdown.missing.length.toString() },
        { label: 'Códigos Incorretos', value: breakdown.incorrect.length.toString() }
      ];

      inventoryReportOverview.innerHTML = '';
      overviewRows.forEach((row) => {
        const tr = document.createElement('tr');
        const labelCell = document.createElement('td');
        labelCell.textContent = row.label;
        const valueCell = document.createElement('td');
        valueCell.textContent = row.value;
        tr.append(labelCell, valueCell);
        inventoryReportOverview.append(tr);
      });

      const fillReportTable = (tbody, items, formatter, columns) => {
        tbody.innerHTML = '';
        if (!items.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = columns;
          td.textContent = 'Nenhum registro.';
          tr.append(td);
          tbody.append(tr);
          return;
        }
        items.forEach((item) => {
          const tr = document.createElement('tr');
          formatter(item).forEach((value) => {
            const td = document.createElement('td');
            td.textContent = value;
            tr.append(td);
          });
          tbody.append(tr);
        });
      };

      fillReportTable(
        inventoryReportIncorrect,
        breakdown.incorrect,
        (item) => [item.code, displayNumber(item.saldoContabil), displayNumber(item.saldoLoja)],
        3
      );

      fillReportTable(
        inventoryReportNonRegistered,
        breakdown.nonRegistered,
        (item) => [item.code, displayNumber(item.quantidade)],
        2
      );

      fillReportTable(
        inventoryReportMissing,
        breakdown.missing,
        (item) => [item.code, displayNumber(item.esperado), displayNumber(item.encontrado)],
        3
      );

      fillReportTable(
        inventoryReportNegative,
        breakdown.negative,
        (item) => [item.code, displayNumber(item.saldoContabil)],
        2
      );

      return true;
    };

    const buildHeaderMap = (rows) => {
      for (let index = 0; index < rows.length; index += 1) {
        const row = rows[index];
        if (!row) continue;
        const map = {};
        row.forEach((cell, cellIndex) => {
          const normalized = normalizeHeader(cell);
          if (!normalized) return;
          if (map.codigo == null && normalized.startsWith('codigo')) {
            map.codigo = cellIndex;
          }
          if (map.produto == null && normalized === 'produto') {
            map.produto = cellIndex;
          }
          if (map.saldoContabil == null && normalized.startsWith('saldo contabil')) {
            map.saldoContabil = cellIndex;
          }
        });
        if (map.codigo != null && map.produto != null && map.saldoContabil != null) {
          return { headerIndex: index, map };
        }
      }
      return null;
    };

    const processWorkbook = (workbook) => {
      if (!workbook || !workbook.SheetNames || !workbook.SheetNames.length) {
        alert('O arquivo selecionado não possui dados reconhecíveis.');
        return;
      }
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      if (!worksheet) {
        alert('Não foi possível ler a planilha selecionada.');
        return;
      }
      const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true, defval: '' });
      if (!rows.length) {
        alert('A planilha selecionada está vazia.');
        return;
      }
      const headerInfo = buildHeaderMap(rows);
      if (!headerInfo) {
        alert('Não foi possível localizar as colunas Código, Produto e Saldo Contábil.');
        return;
      }
      const { headerIndex, map } = headerInfo;
      const imported = [];
      for (let rowIndex = headerIndex + 1; rowIndex < rows.length; rowIndex += 1) {
        const row = rows[rowIndex];
        if (!row) continue;
        const codeRaw = row[map.codigo];
        const productRaw = row[map.produto];
        const saldoRaw = row[map.saldoContabil];
        const code = sanitizeCode((codeRaw ?? '').toString());
        if (!code) {
          continue;
        }
        const product = (productRaw ?? '').toString().trim();
        const parsedSaldo = parseSaldoNumber(saldoRaw);
        imported.push({
          codigo: code,
          produto: product,
          saldoContabil: parsedSaldo,
          saldoTexto: saldoRaw == null ? '' : saldoRaw.toString().trim(),
          saldoLoja: null,
          manualOnly: false
        });
      }
      if (!imported.length) {
        alert('Nenhum registro válido foi encontrado no arquivo selecionado.');
        return;
      }

      const manualSnapshot = new Map();
      inventoryData.forEach((entry) => {
        if (entry.saldoLoja != null) {
          manualSnapshot.set(entry.codigo, { quantidade: entry.saldoLoja, manualOnly: entry.saldoContabil == null });
        }
      });

      inventoryData = imported;
      manualSnapshot.forEach((info, code) => {
        const existing = inventoryData.find((item) => item.codigo === code);
        if (existing) {
          existing.saldoLoja = info.quantidade;
        } else {
          inventoryData.push({
            codigo: code,
            produto: '',
            saldoContabil: null,
            saldoTexto: '',
            saldoLoja: info.quantidade,
            manualOnly: true
          });
        }
      });

      renderInventoryTable();
      syncStorage();
    };

    if (importButton && xlsInput) {
      importButton.addEventListener('click', () => {
        if (!ensureContextSelected()) {
          return;
        }
        xlsInput.click();
      });

      xlsInput.addEventListener('change', (event) => {
        const inputTarget = event.target;
        if (!isContextSelected()) {
          alert('Selecione a loja e o produto antes de importar os dados.');
          focusMissingContext();
          if (inputTarget instanceof HTMLInputElement) {
            inputTarget.value = '';
          }
          return;
        }
        if (!(inputTarget instanceof HTMLInputElement)) {
          return;
        }
        const { files } = inputTarget;
        if (!files || !files.length) return;
        const file = files[0];
        const reader = new FileReader();
        reader.onload = (loadEvent) => {
          try {
            const data = new Uint8Array(loadEvent.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            processWorkbook(workbook);
          } catch (error) {
            console.error('Erro ao importar XLS', error);
            alert('Não foi possível importar o arquivo selecionado.');
          }
        };
        reader.onerror = () => {
          console.error('Erro ao ler o arquivo selecionado.');
          alert('Não foi possível ler o arquivo selecionado.');
        };
        reader.readAsArrayBuffer(file);
        xlsInput.value = '';
      });
    }

    const downloadInventoryCSV = () => {
      if (!ensureContextSelected()) {
        return;
      }
      if (!inventoryData.length) {
        alert('Importe dados antes de exportar.');
        return;
      }
      const lines = [];
      const today = new Date().toLocaleDateString('pt-BR');
      const fileTitle = `${getStoreValue()}-${getProductValue()}-${today}-conferencia`;
      lines.push('Código;Produto;Saldo Contábil;Saldo em Loja;Diferença');
      inventoryData.forEach((entry) => {
        const contabil = entry.saldoContabil != null ? entry.saldoContabil : '';
        const loja = entry.saldoLoja != null ? entry.saldoLoja : '';
        const diff = entry.saldoContabil != null && entry.saldoLoja != null ? entry.saldoContabil - entry.saldoLoja : '';
        lines.push(`${entry.codigo};${entry.produto || ''};${contabil};${loja};${diff}`);
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${fileTitle}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    if (inventoryExportButton) {
      inventoryExportButton.addEventListener('click', downloadInventoryCSV);
    }

    if (inventorySaveButton) {
      inventorySaveButton.addEventListener('click', () => {
        syncStorage();
        alert('Dados de conferência salvos com sucesso.');
      });
    }

    if (inventoryPrintButton) {
      inventoryPrintButton.addEventListener('click', () => {
        if (!ensureContextSelected()) {
          return;
        }
        if (!inventoryData.length) {
          alert('Importe dados de estoque ou cadastre códigos para gerar o relatório.');
          return;
        }
        const ready = buildInventoryReport();
        if (!ready) {
          alert('Não foi possível preparar o relatório para impressão.');
          return;
        }
        setPrintSurface(inventoryReportArea);
        setTimeout(() => window.print(), 50);
      });
    }

    window.addEventListener('load', () => {
      loadStorage();
      renderInventoryTable();
      updateInventorySummary();
      if (isContextSelected()) {
        focusAutoInput();
      } else {
        alert('Selecione a loja e o produto antes de iniciar o cadastro ou importação.');
        focusMissingContext();
      }
    });

    window.addEventListener('beforeunload', (event) => {
      if (inventoryData.length) {
        event.preventDefault();
        event.returnValue = '';
      }
    });

    window.addEventListener('afterprint', () => {
      resetPrintSurface();
      focusAutoInput();
    });
  </script>
</body>
</html>
