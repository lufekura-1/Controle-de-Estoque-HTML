<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Estoque</title>
  <style>
    :root {
      --bg-color: #f5f7fb;
      --chip-bg: #ffffff;
      --accent: #3f51b5;
      --accent-light: #5c6bc0;
      --text: #1f2933;
      --muted: #52606d;
      --border-radius: 18px;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    body {
      margin: 0;
      padding: 24px;
      background: linear-gradient(135deg, #e3eeff 0%, #f8f9ff 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .app-shell {
      display: flex;
      gap: 24px;
      width: 100%;
      max-width: 1400px;
    }

    .sidebar {
      position: sticky;
      top: 24px;
      align-self: flex-start;
      background: var(--chip-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 24px 12px;
      width: 88px;
      min-width: 88px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
      transition: width 0.25s ease, min-width 0.25s ease, padding 0.25s ease;
      overflow: hidden;
    }

    .sidebar:hover {
      width: 220px;
      min-width: 220px;
      align-items: flex-start;
      padding-inline: 18px;
    }

    .nav-button {
      border: none;
      background: transparent;
      padding: 12px;
      border-radius: 16px;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      width: 100%;
    }

    .sidebar:hover .nav-button {
      flex-direction: row;
      justify-content: flex-start;
      gap: 12px;
    }

    .nav-button-icon {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: rgba(63, 81, 181, 0.12);
      color: var(--accent);
      display: grid;
      place-items: center;
      font-size: 1.1rem;
      font-weight: 700;
      flex-shrink: 0;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .nav-button-text {
      opacity: 0;
      transform: translateX(-8px);
      max-width: 0;
      white-space: nowrap;
      transition: opacity 0.2s ease, transform 0.2s ease, max-width 0.2s ease;
    }

    .sidebar:hover .nav-button-text,
    .nav-button:focus-visible .nav-button-text {
      opacity: 1;
      transform: translateX(0);
      max-width: 200px;
    }

    .nav-button:hover {
      background: rgba(63, 81, 181, 0.08);
      color: var(--accent);
    }

    .nav-button:hover .nav-button-icon,
    .nav-button:focus-visible .nav-button-icon {
      background: rgba(63, 81, 181, 0.18);
    }

    .nav-button.active {
      background: rgba(63, 81, 181, 0.12);
      color: var(--accent);
      box-shadow: inset 0 0 0 1px rgba(63, 81, 181, 0.2);
    }

    .nav-button.active .nav-button-icon {
      background: rgba(63, 81, 181, 0.2);
    }

    .page-container {
      flex: 1;
      min-width: 0;
    }

    .page {
      display: none;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .page.active {
      display: block;
    }

    h1 {
      text-align: center;
      color: var(--accent);
      margin-bottom: 24px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .layout-grid {
      display: grid;
      gap: 24px;
      max-width: 1200px;
      margin: 0 auto 48px auto;
    }

    .chip {
      background: var(--chip-bg);
      border-radius: var(--border-radius);
      padding: 18px 22px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .chip-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .inputs-row {
      display: grid;
      gap: 16px;
    }

    .inputs-row.double {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    label {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
      color: var(--muted);
      gap: 6px;
    }

    input[type="text"],
    input[type="number"],
    select {
      border: 1px solid #d1d5db;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 1rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
    }

    .button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .button.secondary {
      background: #e5e7eb;
      color: var(--text);
    }

    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(63, 81, 181, 0.25);
    }

    .button.secondary:hover {
      box-shadow: 0 8px 16px rgba(148, 163, 184, 0.25);
    }

    .button-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .manual-actions {
      display: flex;
      align-items: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .stats-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .stat-card {
      background: rgba(63, 81, 181, 0.07);
      border-radius: 16px;
      padding: 14px 18px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .report-breakdown {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .report-card {
      background: rgba(63, 81, 181, 0.07);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .report-card h3 {
      margin: 0;
      font-size: 0.95rem;
      color: var(--accent);
    }

    .report-card .report-count {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent-light);
    }

    .code-list {
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: 0.9rem;
      max-height: 160px;
      overflow-y: auto;
    }

    .code-list li + li {
      margin-top: 4px;
    }

    .stat-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 1px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--accent-light);
      word-break: break-word;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 18px;
      box-shadow: var(--shadow);
      background: var(--chip-bg);
    }

    .inventory-header {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }

    .inventory-instructions {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
      flex: 1 1 240px;
    }

    .hidden-file-input {
      display: none;
    }

    .saldo-loja-input {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 0.95rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    .saldo-loja-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
    }

    .status-dot {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      display: inline-block;
      background: #cbd5f5;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.6);
    }

    .status-dot--ok {
      background: #22c55e;
    }

    .status-dot--alert {
      background: #ef4444;
    }

    .status-dot--pending {
      background: #9ca3af;
    }

    .empty-state {
      margin-top: 16px;
      text-align: center;
      color: var(--muted);
      font-size: 0.95rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 320px;
    }

    thead {
      background: var(--accent);
      color: white;
    }

    th,
    td {
      padding: 14px 18px;
      text-align: left;
    }

    tbody tr:nth-child(even) {
      background: rgba(63, 81, 181, 0.08);
    }

    .table-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .table-action {
      background: rgba(63, 81, 181, 0.12);
      border: none;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 0.85rem;
      color: var(--accent);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.15s ease;
    }

    .table-action:hover {
      background: rgba(63, 81, 181, 0.22);
      transform: translateY(-1px);
    }

    .sort-button {
      border: none;
      background: rgba(255, 255, 255, 0.25);
      color: white;
      border-radius: 12px;
      padding: 4px 10px;
      margin-left: 10px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .table-title {
      font-weight: 600;
      color: var(--muted);
      padding: 16px 20px 0 20px;
    }

    @media (max-width: 640px) {
      body {
        padding: 16px;
      }

      .chip {
        padding: 16px;
      }
    }

    @media (max-width: 960px) {
      .app-shell {
        flex-direction: column;
      }

      .sidebar {
        position: relative;
        top: 0;
        width: 100%;
        min-width: 0;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 12px;
        overflow-x: auto;
        padding: 12px;
      }

      .sidebar:hover {
        width: 100%;
        min-width: 0;
        align-items: center;
      }

      .nav-button {
        flex: 1 0 auto;
        flex-direction: column;
        justify-content: center;
      }

      .sidebar:hover .nav-button {
        flex-direction: column;
      }

      .nav-button-text {
        opacity: 1;
        transform: translateX(0);
        max-width: none;
      }
    }

    .print-surface {
      display: none;
    }

    .print-surface.print-ready {
      display: block;
    }

    #inventory-report-area {
      background: white;
    }

    .report-section {
      margin-top: 24px;
    }

    .report-section h3 {
      margin: 0 0 12px 0;
      color: var(--accent);
      font-size: 1rem;
    }

    #inventory-report-area table {
      width: 100%;
      border-collapse: collapse;
    }

    #inventory-report-area th,
    #inventory-report-area td {
      border: 1px solid rgba(31, 41, 51, 0.3);
      padding: 8px 10px;
      text-align: left;
    }

    #inventory-report-area th {
      background: rgba(63, 81, 181, 0.12);
      color: var(--accent);
    }

    /* Print layout */
    @media print {
      body {
        background: white;
        padding: 0;
      }

      .sidebar,
      .layout-grid,
      .table-section,
      .report-breakdown,
      .button,
      #modal-overlay {
        display: none !important;
      }

      .page > *:not(.print-surface.print-ready) {
        display: none !important;
      }

      .print-surface.print-ready {
        display: block !important;
        padding: 32px;
        font-size: 12pt;
      }

      #print-title,
      #inventory-report-title {
        font-size: 18pt;
        font-weight: 700;
        margin-bottom: 18px;
      }

      .print-columns {
        display: flex;
        gap: 24px;
      }

      .print-column {
        flex: 1;
      }

      .print-column table {
        width: 100%;
        border-collapse: collapse;
      }

      .print-column th,
      .print-column td {
        border: 1px solid #1f2933;
        padding: 8px;
        text-align: left;
      }
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--chip-bg);
      border-radius: 18px;
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 420px;
      padding: 24px;
      display: none;
      flex-direction: column;
      gap: 16px;
    }

    .modal.active {
      display: flex;
    }

    .modal h2 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--accent);
    }

    .modal-code {
      font-size: 0.95rem;
      color: var(--muted);
    }

    .modal-message {
      min-height: 24px;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar" id="sidebar">
      <button class="nav-button page-nav-button active" data-target="conferencia-page" title="Confer√™ncia de Estoque">
        <span class="nav-button-icon">‚òÖ</span>
        <span class="nav-button-text">Confer√™ncia de Estoque</span>
      </button>
      <button class="nav-button page-nav-button" data-target="manual-page" title="Contagem Manual">
        <span class="nav-button-icon">üìã</span>
        <span class="nav-button-text">Contagem Manual</span>
      </button>
    </aside>
    <main class="page-container">
      <section class="page active" id="conferencia-page">
        <h1>Confer√™ncia de Estoque</h1>

        <div class="layout-grid">
          <div class="chip" id="inventory-data-entry">
            <div class="chip-section-title">Inser√ß√£o de Dados</div>
            <div class="inputs-row">
              <label for="inventory-auto-code">
                Campo Autom√°tico (Leitor)
                <input id="inventory-auto-code" data-role="auto-input" type="text" autocomplete="off" spellcheck="false" placeholder="Aproxime o leitor aqui" />
              </label>
            </div>
            <div class="inputs-row double">
              <label for="inventory-manual-code">
                C√≥digo Manual
                <input id="inventory-manual-code" type="text" placeholder="Informe o c√≥digo" />
              </label>
              <label for="inventory-manual-qty">
                Quantidade
                <input id="inventory-manual-qty" type="number" min="1" value="1" />
              </label>
              <div class="manual-actions">
                <button class="button" id="inventory-manual-add">Adicionar</button>
                <button class="button secondary" id="inventory-manual-check">Conferir</button>
              </div>
            </div>
            <div class="inputs-row double">
              <label for="inventory-store-select">
                Loja
                <select id="inventory-store-select">
                  <option value="Jorel Chicuta">Jorel Chicuta</option>
                  <option value="Jorel Avenida">Jorel Avenida</option>
                  <option value="Ex√≥tica">Ex√≥tica</option>
                </select>
              </label>
              <label for="inventory-product-select">
                Produto
                <select id="inventory-product-select">
                  <option value="Anel">Anel</option>
                  <option value="Brinco">Brinco</option>
                  <option value="Pingente">Pingente</option>
                  <option value="Corrente">Corrente</option>
                  <option value="Pulseira">Pulseira</option>
                  <option value="Alian√ßa">Alian√ßa</option>
                  <option value="Rel√≥gio">Rel√≥gio</option>
                  <option value="Arma√ß√£o">Arma√ß√£o</option>
                  <option value="Solar">Solar</option>
                  <option value="Outro">Outro</option>
                </select>
              </label>
            </div>
            <div class="inventory-header">
              <div class="button-group">
                <button class="button" id="import-xls">Importar XLS</button>
              </div>
              <input type="file" id="xls-input" accept=".xls,.xlsx" class="hidden-file-input" />
              <p class="inventory-instructions">Importe um arquivo contendo as colunas C√≥digo, Produto e Saldo Cont√°bil e informe abaixo o contexto do relat√≥rio.</p>
            </div>
          </div>

          <div class="chip" id="inventory-summary">
            <div class="chip-section-title">Resumo Atual</div>
            <div class="stats-grid">
              <div class="stat-card">
                <span class="stat-label">Quantidade Importada</span>
                <span class="stat-value" id="inventory-total-imported">0</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">Quantidade Cadastrada</span>
                <span class="stat-value" id="inventory-total-registered">0</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">Quantidade Negativa</span>
                <span class="stat-value" id="inventory-total-negatives">0</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">C√≥digos Corretos</span>
                <span class="stat-value" id="inventory-ok-total">0</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">C√≥digos Incorretos</span>
                <span class="stat-value" id="inventory-incorrect-total">0</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">Valor de Correspond√™ncia</span>
                <span class="stat-value" id="inventory-match-percentage">0%</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">√öltimo C√≥digo</span>
                <span class="stat-value" id="inventory-last-code">---</span>
              </div>
            </div>
            <div class="report-breakdown">
              <div class="report-card">
                <h3>C√≥digos Corretos</h3>
                <span class="report-count" id="inventory-correct-count">0</span>
                <ul class="code-list" id="inventory-correct-list"></ul>
              </div>
              <div class="report-card">
                <h3>C√≥digos Incorretos</h3>
                <span class="report-count" id="inventory-incorrect-count">0</span>
                <ul class="code-list" id="inventory-incorrect-list"></ul>
              </div>
              <div class="report-card">
                <h3>C√≥digos n√£o cadastrados</h3>
                <span class="report-count" id="inventory-non-registered-count">0</span>
                <ul class="code-list" id="inventory-non-registered-list"></ul>
              </div>
              <div class="report-card">
                <h3>C√≥digos Faltando</h3>
                <span class="report-count" id="inventory-missing-count">0</span>
                <ul class="code-list" id="inventory-missing-list"></ul>
              </div>
              <div class="report-card">
                <h3>C√≥digos Negativos</h3>
                <span class="report-count" id="inventory-negative-count">0</span>
                <ul class="code-list" id="inventory-negative-list"></ul>
              </div>
            </div>
          </div>

          <div class="chip" id="inventory-export">
            <div class="chip-section-title">Salvar e Exportar</div>
            <div class="button-group">
              <button class="button" id="inventory-print-report">Imprimir Relat√≥rio</button>
              <button class="button" id="inventory-save">Salvar Confer√™ncia</button>
              <button class="button secondary" id="inventory-export-data">Exportar CSV</button>
            </div>
          </div>
        </div>

        <div class="table-section">
          <div class="table-title">Saldos Conferidos</div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Produto</th>
                  <th>Saldo Cont√°bil</th>
                  <th>Saldo em Loja</th>
                  <th>OK</th>
                </tr>
              </thead>
              <tbody id="inventory-table-body"></tbody>
            </table>
          </div>
          <div class="empty-state" id="inventory-empty">Importe um arquivo XLS para visualizar os saldos.</div>
        </div>
        <div id="inventory-report-area" class="print-surface">
          <h2 id="inventory-report-title"></h2>
          <table>
            <thead>
              <tr>
                <th>Resumo</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="inventory-report-overview"></tbody>
          </table>

          <div class="report-section">
            <h3>C√≥digos Incorretos</h3>
            <table>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Saldo Cont√°bil</th>
                  <th>Saldo em Loja</th>
                </tr>
              </thead>
              <tbody id="inventory-report-incorrect"></tbody>
            </table>
          </div>

          <div class="report-section">
            <h3>N√£o Cadastrados</h3>
            <table>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Quantidade</th>
                </tr>
              </thead>
              <tbody id="inventory-report-non-registered"></tbody>
            </table>
          </div>

          <div class="report-section">
            <h3>C√≥digos Faltando</h3>
            <table>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Esperado</th>
                  <th>Encontrado</th>
                </tr>
              </thead>
              <tbody id="inventory-report-missing"></tbody>
            </table>
          </div>

          <div class="report-section">
            <h3>C√≥digos Negativos</h3>
            <table>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Saldo Cont√°bil</th>
                </tr>
              </thead>
              <tbody id="inventory-report-negative"></tbody>
            </table>
          </div>
        </div>
      </section>
      <section class="page" id="manual-page">
        <h1>Controle de Estoque</h1>

        <div class="layout-grid">
          <div class="chip" id="manual-data-entry">
            <div class="chip-section-title">Inser√ß√£o de Dados</div>
            <div class="inputs-row">
              <label for="auto-code">
                Campo Autom√°tico (Leitor)
                <input id="auto-code" data-role="auto-input" type="text" autocomplete="off" spellcheck="false" placeholder="Aproxime o leitor aqui" />
              </label>
            </div>
            <div class="inputs-row double">
              <label for="manual-code">
                C√≥digo Manual
                <input id="manual-code" type="text" placeholder="Informe o c√≥digo" />
              </label>
              <label for="manual-qty">
                Quantidade
                <input id="manual-qty" type="number" min="1" value="1" />
              </label>
              <div class="manual-actions">
                <button class="button" id="manual-add">Adicionar</button>
                <button class="button secondary" id="manual-check">Conferir</button>
              </div>
            </div>
            <div class="inputs-row double">
              <label for="store-select">
                Loja
                <select id="store-select">
                  <option value="Jorel Chicuta">Jorel Chicuta</option>
                  <option value="Jorel Avenida">Jorel Avenida</option>
                  <option value="Ex√≥tica">Ex√≥tica</option>
                </select>
              </label>
              <label for="product-select">
                Produto
                <select id="product-select">
                  <option value="Anel">Anel</option>
                  <option value="Brinco">Brinco</option>
                  <option value="Pingente">Pingente</option>
                  <option value="Corrente">Corrente</option>
                  <option value="Pulseira">Pulseira</option>
                  <option value="Alian√ßa">Alian√ßa</option>
                  <option value="Rel√≥gio">Rel√≥gio</option>
                  <option value="Arma√ß√£o">Arma√ß√£o</option>
                  <option value="Solar">Solar</option>
                  <option value="Outro">Outro</option>
                </select>
              </label>
            </div>
          </div>

          <div class="chip" id="manual-summary">
            <div class="chip-section-title">Resumo Atual</div>
            <div class="stats-grid">
              <div class="stat-card">
                <span class="stat-label">Quantidade Total</span>
                <span class="stat-value" id="total-quantity">0</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">√öltimo C√≥digo</span>
                <span class="stat-value" id="last-code">---</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">Loja</span>
                <span class="stat-value" id="summary-store">Jorel Chicuta</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">Produto</span>
                <span class="stat-value" id="summary-product">Anel</span>
              </div>
            </div>
          </div>

          <div class="chip" id="manual-export">
            <div class="chip-section-title">Salvar e Exportar</div>
            <div class="button-group">
              <button class="button" id="print-pdf">Imprimir PDF</button>
              <button class="button" id="save-data">Salvar</button>
              <button class="button secondary" id="reset-data">Resetar</button>
              <button class="button" id="download-table">Baixar Tabela</button>
            </div>
          </div>
        </div>

        <div class="table-section">
          <div class="table-title">Tabela de C√≥digos</div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>
                    C√≥digo
                    <button class="sort-button" id="sort-toggle">Ordem ‚Üë</button>
                  </th>
                  <th>Quantidade</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="table-body"></tbody>
            </table>
          </div>
        </div>

        <div id="print-area" class="print-surface">
          <div id="print-title"></div>
          <div class="print-columns">
            <div class="print-column">
              <table>
                <thead>
                  <tr><th>C√≥digo</th><th>Quantidade</th></tr>
                </thead>
                <tbody id="print-table-left"></tbody>
              </table>
            </div>
            <div class="print-column">
              <table>
                <thead>
                  <tr><th>C√≥digo</th><th>Quantidade</th></tr>
                </thead>
                <tbody id="print-table-right"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      
    </main>
  </div>

  <div id="modal-overlay" class="modal-overlay">
    <div class="modal" id="verify-modal">
      <h2>Conferir Produto</h2>
      <label for="verify-code">
        C√≥digo
        <input id="verify-code" type="text" autocomplete="off" spellcheck="false" placeholder="Informe o c√≥digo" />
      </label>
      <div class="modal-message" id="verify-message"></div>
      <div class="modal-buttons">
        <button class="button secondary" id="verify-close">Fechar</button>
        <button class="button" id="verify-submit">Verificar</button>
      </div>
      <div class="modal-buttons hidden" id="verify-prompt">
        <button class="button secondary" id="verify-no-edit">N√£o</button>
        <button class="button" id="verify-yes-edit">Sim</button>
      </div>
    </div>

    <div class="modal" id="edit-modal">
      <h2>Editar Item</h2>
      <div class="modal-code">C√≥digo: <strong id="edit-code-display"></strong></div>
      <label for="edit-qty">
        Quantidade
        <input id="edit-qty" type="number" min="1" />
      </label>
      <div class="modal-buttons">
        <button class="button secondary" id="edit-cancel">Cancelar</button>
        <button class="button" id="edit-save">Salvar</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const pageNavButtons = document.querySelectorAll('.page-nav-button');
    const pages = document.querySelectorAll('.page');
    const autoInput = document.getElementById('auto-code');
    const manualCodeInput = document.getElementById('manual-code');
    const manualQtyInput = document.getElementById('manual-qty');
    const manualAddButton = document.getElementById('manual-add');
    const manualCheckButton = document.getElementById('manual-check');
    const inventoryAutoInput = document.getElementById('inventory-auto-code');
    const inventoryManualCodeInput = document.getElementById('inventory-manual-code');
    const inventoryManualQtyInput = document.getElementById('inventory-manual-qty');
    const inventoryManualAddButton = document.getElementById('inventory-manual-add');
    const inventoryManualCheckButton = document.getElementById('inventory-manual-check');
    const storeSelect = document.getElementById('store-select');
    const productSelect = document.getElementById('product-select');
    const inventoryStoreSelect = document.getElementById('inventory-store-select');
    const inventoryProductSelect = document.getElementById('inventory-product-select');
    const totalQuantityEl = document.getElementById('total-quantity');
    const lastCodeEl = document.getElementById('last-code');
    const inventoryLastCodeEl = document.getElementById('inventory-last-code');
    const summaryStoreEl = document.getElementById('summary-store');
    const summaryProductEl = document.getElementById('summary-product');
    const tableBody = document.getElementById('table-body');
    const sortToggle = document.getElementById('sort-toggle');
    const printButton = document.getElementById('print-pdf');
    const saveButton = document.getElementById('save-data');
    const resetButton = document.getElementById('reset-data');
    const downloadButton = document.getElementById('download-table');
    const printTitleEl = document.getElementById('print-title');
    const printLeftBody = document.getElementById('print-table-left');
    const printRightBody = document.getElementById('print-table-right');
    const modalOverlay = document.getElementById('modal-overlay');
    const verifyModal = document.getElementById('verify-modal');
    const editModal = document.getElementById('edit-modal');
    const verifyCodeInput = document.getElementById('verify-code');
    const verifyMessage = document.getElementById('verify-message');
    const verifySubmit = document.getElementById('verify-submit');
    const verifyClose = document.getElementById('verify-close');
    const verifyPrompt = document.getElementById('verify-prompt');
    const verifyYesEdit = document.getElementById('verify-yes-edit');
    const verifyNoEdit = document.getElementById('verify-no-edit');
    const editCodeDisplay = document.getElementById('edit-code-display');
    const editQtyInput = document.getElementById('edit-qty');
    const editCancel = document.getElementById('edit-cancel');
    const editSave = document.getElementById('edit-save');
    const inventoryTableBody = document.getElementById('inventory-table-body');
    const inventoryEmptyState = document.getElementById('inventory-empty');
    const importButton = document.getElementById('import-xls');
    const xlsInput = document.getElementById('xls-input');
    const inventoryTotals = {
      imported: document.getElementById('inventory-total-imported'),
      registered: document.getElementById('inventory-total-registered'),
      negatives: document.getElementById('inventory-total-negatives'),
      ok: document.getElementById('inventory-ok-total'),
      incorrect: document.getElementById('inventory-incorrect-total'),
      match: document.getElementById('inventory-match-percentage')
    };
    const inventoryBreakdownCounts = {
      correct: document.getElementById('inventory-correct-count'),
      incorrect: document.getElementById('inventory-incorrect-count'),
      nonRegistered: document.getElementById('inventory-non-registered-count'),
      missing: document.getElementById('inventory-missing-count'),
      negative: document.getElementById('inventory-negative-count')
    };
    const inventoryBreakdownLists = {
      correct: document.getElementById('inventory-correct-list'),
      incorrect: document.getElementById('inventory-incorrect-list'),
      nonRegistered: document.getElementById('inventory-non-registered-list'),
      missing: document.getElementById('inventory-missing-list'),
      negative: document.getElementById('inventory-negative-list')
    };
    const inventoryPrintButton = document.getElementById('inventory-print-report');
    const inventorySaveButton = document.getElementById('inventory-save');
    const inventoryExportButton = document.getElementById('inventory-export-data');
    const inventoryReportArea = document.getElementById('inventory-report-area');
    const inventoryReportTitle = document.getElementById('inventory-report-title');
    const inventoryReportOverview = document.getElementById('inventory-report-overview');
    const inventoryReportIncorrect = document.getElementById('inventory-report-incorrect');
    const inventoryReportNonRegistered = document.getElementById('inventory-report-non-registered');
    const inventoryReportMissing = document.getElementById('inventory-report-missing');
    const inventoryReportNegative = document.getElementById('inventory-report-negative');

    let dataEntries = [];
    let sortDirection = 'asc';
    let inventoryData = [];
    let currentPrintSurface = null;
    let lastEntryDurationMs = null;
    let lastEntryMode = 'auto';
    let pendingVerifyCode = null;
    let currentEditingCode = null;

    const STORAGE_KEY = 'controle-estoque-data';

    const getStoreValue = () => {
      if (inventoryStoreSelect && inventoryStoreSelect.value) {
        return inventoryStoreSelect.value;
      }
      return storeSelect.value;
    };

    const getProductValue = () => {
      if (inventoryProductSelect && inventoryProductSelect.value) {
        return inventoryProductSelect.value;
      }
      return productSelect.value;
    };

    const getCurrentTitle = () => {
      const today = new Date();
      const dateStr = today.toLocaleDateString('pt-BR');
      return `${getStoreValue()}-${getProductValue()}-${dateStr}`;
    };

    const sanitizeCode = (value) => {
      return value.replace(/[^\w-]/gi, '').toUpperCase();
    };

    const focusAutoInput = () => {
      const activePage = document.querySelector('.page.active');
      if (!activePage) return;
      const autoField = activePage.querySelector('[data-role="auto-input"]');
      if (autoField instanceof HTMLInputElement) {
        setTimeout(() => autoField.focus({ preventScroll: true }), 50);
      }
    };

    const activatePage = (targetId) => {
      pages.forEach((page) => {
        page.classList.toggle('active', page.id === targetId);
      });
      pageNavButtons.forEach((btn) => {
        btn.classList.toggle('active', btn.dataset.target === targetId);
      });
      focusAutoInput();
    };

    pageNavButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const target = button.dataset.target;
        if (!target) return;
        activatePage(target);
      });
    });

    const normalizeHeader = (value) => {
      if (value == null) return '';
      return value
        .toString()
        .trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    };

    const parseSaldoNumber = (value) => {
      if (value == null || value === '') return null;
      if (typeof value === 'number') return value;
      const normalized = value.toString().trim();
      if (!normalized) return null;
      const compact = normalized.replace(/\s+/g, '');
      const hasComma = compact.includes(',');
      const hasDot = compact.includes('.');
      let candidate = compact;
      if (hasComma && hasDot) {
        candidate = candidate.replace(/\./g, '').replace(',', '.');
      } else if (hasComma) {
        candidate = candidate.replace(',', '.');
      }
      const parsed = Number(candidate);
      if (!Number.isNaN(parsed)) {
        return parsed;
      }
      return null;
    };

    const formatInventoryNumber = (value) => {
      if (value == null || value === '') return '';
      const number = Number(value);
      if (Number.isNaN(number)) {
        return value.toString();
      }
      return new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 4
      }).format(number);
    };

    const displayNumber = (value) => {
      if (value == null || value === '') {
        return '‚Äî';
      }
      return formatInventoryNumber(value);
    };

    const fillList = (element, items, formatter) => {
      if (!element) return;
      element.innerHTML = '';
      if (!items.length) {
        const emptyItem = document.createElement('li');
        emptyItem.textContent = 'Nenhum registro.';
        element.append(emptyItem);
        return;
      }
      items.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = formatter(item);
        element.append(li);
      });
    };

    const computeInventoryMetrics = () => {
      const manualMap = new Map(dataEntries.map((entry) => [entry.code, entry.quantity]));
      const importedSet = new Set(inventoryData.map((entry) => entry.codigo));
      const totals = { imported: 0, registered: 0, negatives: 0 };
      const counters = { compared: 0, ok: 0, incorrect: 0 };
      const breakdownMaps = {
        correct: new Map(),
        incorrect: new Map(),
        nonRegistered: new Map(),
        missing: new Map(),
        negative: new Map()
      };

      inventoryData.forEach((entry) => {
        const code = entry.codigo;
        const contabil = typeof entry.saldoContabil === 'number' ? entry.saldoContabil : null;
        const loja = typeof entry.saldoLoja === 'number' ? entry.saldoLoja : null;

        if (contabil != null) {
          totals.imported += contabil;
          if (contabil < 0) {
            totals.negatives += 1;
            if (!manualMap.has(code)) {
              breakdownMaps.negative.set(code, { code, saldoContabil: contabil });
            }
          }
        }

        if (loja != null) {
          totals.registered += loja;
        }

        if (contabil != null && loja != null) {
          counters.compared += 1;
          if (Math.abs(contabil - loja) < 0.000001) {
            counters.ok += 1;
            breakdownMaps.correct.set(code, { code, saldoContabil: contabil });
          } else {
            counters.incorrect += 1;
            breakdownMaps.incorrect.set(code, { code, saldoContabil: contabil, saldoLoja: loja });
            if (loja < contabil) {
              breakdownMaps.missing.set(code, { code, esperado: contabil, encontrado: loja });
            }
          }
        } else if (contabil != null && loja == null) {
          breakdownMaps.missing.set(code, { code, esperado: contabil, encontrado: null });
        }
      });

      dataEntries.forEach((entry) => {
        if (!importedSet.has(entry.code)) {
          breakdownMaps.nonRegistered.set(entry.code, { code: entry.code, quantidade: entry.quantity });
          if (!breakdownMaps.missing.has(entry.code)) {
            breakdownMaps.missing.set(entry.code, { code: entry.code, esperado: 0, encontrado: entry.quantity });
          }
        }
      });

      const matchPercentage = counters.compared ? (counters.ok / counters.compared) * 100 : 0;

      return {
        totals,
        counters: {
          ok: counters.ok,
          incorrect: counters.incorrect,
          matchPercentage
        },
        breakdown: {
          correct: Array.from(breakdownMaps.correct.values()),
          incorrect: Array.from(breakdownMaps.incorrect.values()),
          nonRegistered: Array.from(breakdownMaps.nonRegistered.values()),
          missing: Array.from(breakdownMaps.missing.values()),
          negative: Array.from(breakdownMaps.negative.values())
        }
      };
    };

    const updateInventorySummary = () => {
      if (!inventoryTotals.imported) return;
      const metrics = computeInventoryMetrics();
      const { totals, counters, breakdown } = metrics;

      inventoryTotals.imported.textContent = formatInventoryNumber(totals.imported);
      inventoryTotals.registered.textContent = formatInventoryNumber(totals.registered);
      inventoryTotals.negatives.textContent = totals.negatives.toString();
      inventoryTotals.ok.textContent = counters.ok.toString();
      inventoryTotals.incorrect.textContent = counters.incorrect.toString();
      inventoryTotals.match.textContent = `${counters.matchPercentage.toFixed(2)}%`;

      inventoryBreakdownCounts.correct.textContent = breakdown.correct.length.toString();
      inventoryBreakdownCounts.incorrect.textContent = breakdown.incorrect.length.toString();
      inventoryBreakdownCounts.nonRegistered.textContent = breakdown.nonRegistered.length.toString();
      inventoryBreakdownCounts.missing.textContent = breakdown.missing.length.toString();
      inventoryBreakdownCounts.negative.textContent = breakdown.negative.length.toString();

      fillList(inventoryBreakdownLists.correct, breakdown.correct, (item) => `${item.code} ‚Ä¢ ${displayNumber(item.saldoContabil)}`);
      fillList(inventoryBreakdownLists.incorrect, breakdown.incorrect, (item) => `${item.code} ‚Ä¢ Cont√°bil: ${displayNumber(item.saldoContabil)} | Loja: ${displayNumber(item.saldoLoja)}`);
      fillList(inventoryBreakdownLists.nonRegistered, breakdown.nonRegistered, (item) => `${item.code} ‚Ä¢ Quantidade: ${displayNumber(item.quantidade)}`);
      fillList(inventoryBreakdownLists.missing, breakdown.missing, (item) => `${item.code} ‚Ä¢ Esperado: ${displayNumber(item.esperado)} | Encontrado: ${displayNumber(item.encontrado)}`);
      fillList(inventoryBreakdownLists.negative, breakdown.negative, (item) => `${item.code} ‚Ä¢ Saldo: ${displayNumber(item.saldoContabil)}`);
    };

    const updateStatusDot = (dot, entry) => {
      dot.className = 'status-dot';
      if (entry.saldoContabil == null) {
        dot.classList.add('status-dot--pending');
        dot.title = 'Saldo cont√°bil inv√°lido';
        return;
      }
      if (entry.saldoLoja == null) {
        dot.classList.add('status-dot--pending');
        dot.title = 'Aguardando confer√™ncia';
        return;
      }
      if (Math.abs(entry.saldoLoja - entry.saldoContabil) < 0.000001) {
        dot.classList.add('status-dot--ok');
        dot.title = 'Valores conferidos';
      } else {
        dot.classList.add('status-dot--alert');
        dot.title = 'Diverg√™ncia encontrada';
      }
    };

    const renderInventoryTable = () => {
      if (!inventoryTableBody || !inventoryEmptyState) return;
      inventoryTableBody.innerHTML = '';
      if (!inventoryData.length) {
        inventoryEmptyState.classList.remove('hidden');
        updateInventorySummary();
        return;
      }
      inventoryEmptyState.classList.add('hidden');
      inventoryData.forEach((entry, index) => {
        const row = document.createElement('tr');
        const codeCell = document.createElement('td');
        codeCell.textContent = entry.codigo;
        const productCell = document.createElement('td');
        productCell.textContent = entry.produto || '‚Äî';
        const saldoContabilCell = document.createElement('td');
        const saldoDisplay = entry.saldoContabil != null ? entry.saldoContabil : entry.saldoTexto;
        saldoContabilCell.textContent = formatInventoryNumber(saldoDisplay);
        const saldoLojaCell = document.createElement('td');
        const saldoInput = document.createElement('input');
        saldoInput.type = 'number';
        saldoInput.step = 'any';
        saldoInput.min = '0';
        saldoInput.className = 'saldo-loja-input';
        saldoInput.dataset.index = index.toString();
        saldoInput.value = entry.saldoLoja == null ? '' : entry.saldoLoja;
        saldoLojaCell.append(saldoInput);
        const statusCell = document.createElement('td');
        const statusDot = document.createElement('span');
        statusDot.className = 'status-dot';
        updateStatusDot(statusDot, entry);
        statusCell.append(statusDot);
        row.append(codeCell, productCell, saldoContabilCell, saldoLojaCell, statusCell);
        inventoryTableBody.append(row);
      });
      updateInventorySummary();
    };

    const buildHeaderMap = (rows) => {
      for (let index = 0; index < rows.length; index += 1) {
        const row = rows[index];
        if (!row) continue;
        const map = {};
        row.forEach((cell, cellIndex) => {
          const normalized = normalizeHeader(cell);
          if (!normalized) return;
          if (map.codigo == null && normalized.startsWith('codigo')) {
            map.codigo = cellIndex;
          }
          if (map.produto == null && normalized === 'produto') {
            map.produto = cellIndex;
          }
          if (map.saldoContabil == null && normalized.startsWith('saldo contabil')) {
            map.saldoContabil = cellIndex;
          }
        });
        if (map.codigo != null && map.produto != null && map.saldoContabil != null) {
          return { headerIndex: index, map };
        }
      }
      return null;
    };

    const processWorkbook = (workbook) => {
      if (!workbook || !workbook.SheetNames || !workbook.SheetNames.length) {
        alert('O arquivo selecionado n√£o possui dados reconhec√≠veis.');
        return;
      }
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      if (!worksheet) {
        alert('N√£o foi poss√≠vel ler a planilha selecionada.');
        return;
      }
      const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true, defval: '' });
      if (!rows.length) {
        alert('A planilha selecionada est√° vazia.');
        inventoryData = [];
        renderInventoryTable();
        syncStorage();
        return;
      }
      const headerInfo = buildHeaderMap(rows);
      if (!headerInfo) {
        alert('N√£o foi poss√≠vel localizar as colunas C√≥digo, Produto e Saldo Cont√°bil.');
        inventoryData = [];
        renderInventoryTable();
        syncStorage();
        return;
      }
      const { headerIndex, map } = headerInfo;
      const imported = [];
      for (let rowIndex = headerIndex + 1; rowIndex < rows.length; rowIndex += 1) {
        const row = rows[rowIndex];
        if (!row) continue;
        const isEmpty = ['codigo', 'produto', 'saldoContabil'].every((key) => {
          const cell = row[map[key]];
          return cell == null || cell === '';
        });
        if (isEmpty) {
          if (imported.length) {
            break;
          }
          continue;
        }
        const codeRaw = row[map.codigo];
        const productRaw = row[map.produto];
        const saldoRaw = row[map.saldoContabil];
        const code = (codeRaw ?? '').toString().trim();
        const product = (productRaw ?? '').toString().trim();
        if (!code) {
          continue;
        }
        const parsedSaldo = parseSaldoNumber(saldoRaw);
        imported.push({
          codigo: code,
          produto: product,
          saldoContabil: parsedSaldo,
          saldoTexto: saldoRaw == null ? '' : saldoRaw.toString().trim(),
          saldoLoja: null
        });
      }
      if (!imported.length) {
        alert('Nenhum registro v√°lido foi encontrado no arquivo selecionado.');
        inventoryData = [];
        renderInventoryTable();
        syncStorage();
        return;
      }
      inventoryData = imported;
      renderInventoryTable();
      syncStorage();
      activatePage('conferencia-page');
    };

    if (importButton && xlsInput) {
      importButton.addEventListener('click', () => {
        xlsInput.click();
      });

      xlsInput.addEventListener('change', (event) => {
        const { files } = event.target;
        if (!files || !files.length) return;
        const file = files[0];
        const reader = new FileReader();
        reader.onload = (loadEvent) => {
          try {
            const data = new Uint8Array(loadEvent.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            processWorkbook(workbook);
          } catch (error) {
            console.error('Erro ao importar XLS', error);
            alert('N√£o foi poss√≠vel importar o arquivo selecionado.');
          }
        };
        reader.onerror = () => {
          console.error('Erro ao ler o arquivo selecionado.');
          alert('N√£o foi poss√≠vel ler o arquivo selecionado.');
        };
        reader.readAsArrayBuffer(file);
        xlsInput.value = '';
      });
    }

    if (inventoryTableBody) {
      inventoryTableBody.addEventListener('input', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) return;
        if (!target.classList.contains('saldo-loja-input')) return;
        const index = Number(target.dataset.index);
        if (Number.isNaN(index) || !inventoryData[index]) return;
        const rawValue = target.value;
        if (rawValue === '') {
          inventoryData[index].saldoLoja = null;
        } else {
          const normalized = rawValue.replace(',', '.');
          const parsed = Number(normalized);
          if (Number.isNaN(parsed)) {
            return;
          }
          inventoryData[index].saldoLoja = parsed;
        }
        const row = target.closest('tr');
        const dot = row ? row.querySelector('.status-dot') : null;
        if (dot instanceof HTMLElement) {
          updateStatusDot(dot, inventoryData[index]);
        }
        updateInventorySummary();
        syncStorage();
      });
    }

    const updateSummary = () => {
      const total = dataEntries.reduce((sum, entry) => sum + entry.quantity, 0);
      totalQuantityEl.textContent = total.toString();
      summaryStoreEl.textContent = storeSelect.value;
      summaryProductEl.textContent = productSelect.value;
    };

    const updateLastCode = (code, durationMs, mode) => {
      if (!code) {
        lastCodeEl.textContent = '---';
        if (inventoryLastCodeEl) {
          inventoryLastCodeEl.textContent = '---';
        }
        return;
      }
      if (mode === 'manual' || durationMs == null) {
        lastCodeEl.textContent = `${code} (Manual)`;
        if (inventoryLastCodeEl) {
          inventoryLastCodeEl.textContent = `${code} (Manual)`;
        }
      } else {
        const seconds = (durationMs / 1000).toFixed(2);
        lastCodeEl.textContent = `${code} (Tempo: ${seconds}s)`;
        if (inventoryLastCodeEl) {
          inventoryLastCodeEl.textContent = `${code} (Tempo: ${seconds}s)`;
        }
      }
    };

    const renderTable = () => {
      const sorted = [...dataEntries].sort((a, b) => {
        const comparison = a.code.localeCompare(b.code, 'pt-BR', {
          numeric: true,
          sensitivity: 'base'
        });
        return sortDirection === 'asc' ? comparison : -comparison;
      });
      tableBody.innerHTML = '';
      sorted.forEach((entry) => {
        const row = document.createElement('tr');
        const codeCell = document.createElement('td');
        const qtyCell = document.createElement('td');
        const actionsCell = document.createElement('td');
        codeCell.textContent = entry.code;
        qtyCell.textContent = entry.quantity;
        actionsCell.className = 'table-actions';
        const editButton = document.createElement('button');
        editButton.className = 'table-action edit-action';
        editButton.textContent = 'Editar';
        editButton.dataset.code = entry.code;
        const deleteButton = document.createElement('button');
        deleteButton.className = 'table-action delete-action';
        deleteButton.textContent = 'Excluir';
        deleteButton.dataset.code = entry.code;
        actionsCell.append(editButton, deleteButton);
        row.append(codeCell, qtyCell, actionsCell);
        tableBody.append(row);
      });
      updateSummary();
      updateInventorySummary();
    };

    const syncStorage = () => {
      const payload = {
        entries: dataEntries,
        inventory: inventoryData,
        store: storeSelect.value,
        product: productSelect.value,
        lastCode: lastCodeEl.textContent
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    };

    const loadStorage = () => {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (!stored) return;
      try {
        const payload = JSON.parse(stored);
        if (payload.entries && Array.isArray(payload.entries)) {
          dataEntries = payload.entries
            .map((item) => ({
              code: item.code,
              quantity: Number(item.quantity) || 0
            }))
            .filter((item) => item.code && item.quantity > 0);
        }
        if (payload.store) {
          storeSelect.value = payload.store;
          if (inventoryStoreSelect) {
            inventoryStoreSelect.value = payload.store;
          }
        }
        if (payload.product) {
          productSelect.value = payload.product;
          if (inventoryProductSelect) {
            inventoryProductSelect.value = payload.product;
          }
        }
        if (payload.inventory && Array.isArray(payload.inventory)) {
          inventoryData = payload.inventory
            .map((item) => ({
              codigo: item.codigo,
              produto: item.produto || '',
              saldoContabil: typeof item.saldoContabil === 'number' ? item.saldoContabil : parseSaldoNumber(item.saldoContabil),
              saldoTexto: item.saldoTexto || '',
              saldoLoja:
                item.saldoLoja == null
                  ? null
                  : typeof item.saldoLoja === 'number'
                  ? item.saldoLoja
                  : parseSaldoNumber(item.saldoLoja)
            }))
            .filter((item) => item.codigo);
        }
        if (payload.lastCode) {
          lastCodeEl.textContent = payload.lastCode;
          if (inventoryLastCodeEl) {
            inventoryLastCodeEl.textContent = payload.lastCode;
          }
        }
      } catch (error) {
        console.error('Erro ao carregar dados salvos', error);
      }
    };

    const upsertEntry = (code, quantity) => {
      if (!code || quantity <= 0) return;
      const sanitized = sanitizeCode(code);
      if (!sanitized) return;
      const existing = dataEntries.find((item) => item.code === sanitized);
      if (existing) {
        existing.quantity += quantity;
      } else {
        dataEntries.push({ code: sanitized, quantity });
      }
      sortDirection = 'asc';
      sortToggle.textContent = 'Ordem ‚Üë';
      renderTable();
      updateLastCode(sanitized, lastEntryDurationMs, lastEntryMode);
      lastEntryDurationMs = null;
      lastEntryMode = 'auto';
      syncStorage();
    };

    const setupDataEntryForm = (form) => {
      const { autoInput: autoField, manualCodeInput: codeField, manualQtyInput: qtyField, addButton, checkButton } = form;
      if (!autoField || !codeField || !qtyField || !addButton) {
        return;
      }

      let scanStartTime = null;

      autoField.addEventListener('keydown', (event) => {
        if (event.key === 'Tab') {
          event.preventDefault();
        }
        if ((event.ctrlKey || event.metaKey) && ['w', 'W', 'r', 'R'].includes(event.key)) {
          event.preventDefault();
        }
        if (event.key === 'F5' || event.key === 'F11' || (event.altKey && event.key === 'F4')) {
          event.preventDefault();
        }
        const allowedControlKeys = ['Backspace', 'Enter', 'Delete', 'ArrowLeft', 'ArrowRight'];
        const isAlphaNumeric = /[\w-]/.test(event.key);
        if (!isAlphaNumeric && !allowedControlKeys.includes(event.key)) {
          event.preventDefault();
        }
        if (scanStartTime == null && isAlphaNumeric) {
          scanStartTime = performance.now();
        }
        if (event.key === 'Enter') {
          event.preventDefault();
          const sanitized = sanitizeCode(autoField.value);
          if (sanitized) {
            const scanEnd = performance.now();
            lastEntryDurationMs = scanStartTime ? scanEnd - scanStartTime : 0;
            lastEntryMode = 'auto';
            upsertEntry(sanitized, 1);
          }
          autoField.value = '';
          scanStartTime = null;
          focusAutoInput();
        }
      });

      autoField.addEventListener('input', () => {
        const sanitized = sanitizeCode(autoField.value);
        if (sanitized !== autoField.value) {
          autoField.value = sanitized;
        }
      });

      addButton.addEventListener('click', () => {
        const code = sanitizeCode(codeField.value);
        const quantity = Number(qtyField.value) || 0;
        if (!code) {
          alert('Informe um c√≥digo v√°lido.');
          return;
        }
        if (quantity <= 0) {
          alert('Informe uma quantidade v√°lida.');
          return;
        }
        lastEntryDurationMs = null;
        lastEntryMode = 'manual';
        upsertEntry(code, quantity);
        codeField.value = '';
        qtyField.value = '1';
        focusAutoInput();
      });

      if (checkButton) {
        checkButton.addEventListener('click', () => {
          openVerifyModal();
        });
      }

      codeField.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          addButton.click();
        }
      });

      qtyField.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          addButton.click();
        }
      });
    };

    const dataEntryForms = [
      {
        autoInput,
        manualCodeInput,
        manualQtyInput,
        addButton: manualAddButton,
        checkButton: manualCheckButton
      },
      {
        autoInput: inventoryAutoInput,
        manualCodeInput: inventoryManualCodeInput,
        manualQtyInput: inventoryManualQtyInput,
        addButton: inventoryManualAddButton,
        checkButton: inventoryManualCheckButton
      }
    ];

    dataEntryForms.forEach((form) => setupDataEntryForm(form));

    storeSelect.addEventListener('change', () => {
      summaryStoreEl.textContent = storeSelect.value;
      if (inventoryStoreSelect && inventoryStoreSelect.value !== storeSelect.value) {
        inventoryStoreSelect.value = storeSelect.value;
      }
      syncStorage();
      updateInventorySummary();
    });

    productSelect.addEventListener('change', () => {
      summaryProductEl.textContent = productSelect.value;
      if (inventoryProductSelect && inventoryProductSelect.value !== productSelect.value) {
        inventoryProductSelect.value = productSelect.value;
      }
      syncStorage();
      updateInventorySummary();
    });

    if (inventoryStoreSelect) {
      inventoryStoreSelect.addEventListener('change', () => {
        if (storeSelect.value !== inventoryStoreSelect.value) {
          storeSelect.value = inventoryStoreSelect.value;
          summaryStoreEl.textContent = storeSelect.value;
        }
        syncStorage();
        updateInventorySummary();
      });
    }

    if (inventoryProductSelect) {
      inventoryProductSelect.addEventListener('change', () => {
        if (productSelect.value !== inventoryProductSelect.value) {
          productSelect.value = inventoryProductSelect.value;
          summaryProductEl.textContent = productSelect.value;
        }
        syncStorage();
        updateInventorySummary();
      });
    }

    sortToggle.addEventListener('click', () => {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      sortToggle.textContent = sortDirection === 'asc' ? 'Ordem ‚Üë' : 'Ordem ‚Üì';
      renderTable();
    });

    const setPrintSurface = (element) => {
      if (!element) return;
      if (currentPrintSurface) {
        currentPrintSurface.classList.remove('print-ready');
      }
      currentPrintSurface = element;
      currentPrintSurface.classList.add('print-ready');
    };

    const resetPrintSurface = () => {
      if (currentPrintSurface) {
        currentPrintSurface.classList.remove('print-ready');
        currentPrintSurface = null;
      }
    };

    const preparePrintTables = () => {
      const sorted = [...dataEntries].sort((a, b) =>
        a.code.localeCompare(b.code, 'pt-BR', {
          numeric: true,
          sensitivity: 'base'
        })
      );
      const midpoint = Math.ceil(sorted.length / 2);
      const left = sorted.slice(0, midpoint);
      const right = sorted.slice(midpoint);
      const fillTable = (tbody, items) => {
        tbody.innerHTML = '';
        items.forEach((entry) => {
          const row = document.createElement('tr');
          const codeCell = document.createElement('td');
          const qtyCell = document.createElement('td');
          codeCell.textContent = entry.code;
          qtyCell.textContent = entry.quantity;
          row.append(codeCell, qtyCell);
          tbody.append(row);
        });
      };
      fillTable(printLeftBody, left);
      fillTable(printRightBody, right);
      printTitleEl.textContent = getCurrentTitle();
    };

    const buildInventoryReport = () => {
      if (!inventoryReportArea) return;
      const metrics = computeInventoryMetrics();
      const { totals, counters, breakdown } = metrics;
      const today = new Date().toLocaleDateString('pt-BR');
      const storeName = getStoreValue();
      const productName = getProductValue();
      inventoryReportTitle.textContent = `${storeName} - ${today} - ${productName}`;

      const overviewRows = [
        { label: 'Quantidade Importada', value: formatInventoryNumber(totals.imported) },
        { label: 'Quantidade Cadastrada', value: formatInventoryNumber(totals.registered) },
        { label: 'Quantidade Negativa', value: totals.negatives.toString() },
        { label: 'C√≥digos Corretos', value: counters.ok.toString() },
        { label: 'C√≥digos Incorretos', value: counters.incorrect.toString() },
        { label: 'Valor de Correspond√™ncia', value: `${counters.matchPercentage.toFixed(2)}%` }
      ];

      inventoryReportOverview.innerHTML = '';
      overviewRows.forEach((row) => {
        const tr = document.createElement('tr');
        const labelCell = document.createElement('td');
        labelCell.textContent = row.label;
        const valueCell = document.createElement('td');
        valueCell.textContent = row.value;
        tr.append(labelCell, valueCell);
        inventoryReportOverview.append(tr);
      });

      const fillReportTable = (tbody, items, formatter, columns) => {
        tbody.innerHTML = '';
        if (!items.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = columns;
          td.textContent = 'Nenhum registro.';
          tr.append(td);
          tbody.append(tr);
          return;
        }
        items.forEach((item) => {
          const tr = document.createElement('tr');
          formatter(item).forEach((value) => {
            const td = document.createElement('td');
            td.textContent = value;
            tr.append(td);
          });
          tbody.append(tr);
        });
      };

      fillReportTable(
        inventoryReportIncorrect,
        breakdown.incorrect,
        (item) => [item.code, displayNumber(item.saldoContabil), displayNumber(item.saldoLoja)],
        3
      );

      fillReportTable(
        inventoryReportNonRegistered,
        breakdown.nonRegistered,
        (item) => [item.code, displayNumber(item.quantidade)],
        2
      );

      fillReportTable(
        inventoryReportMissing,
        breakdown.missing,
        (item) => [item.code, displayNumber(item.esperado), displayNumber(item.encontrado)],
        3
      );

      fillReportTable(
        inventoryReportNegative,
        breakdown.negative,
        (item) => [item.code, displayNumber(item.saldoContabil)],
        2
      );
    };

    printButton.addEventListener('click', () => {
      if (!dataEntries.length) {
        alert('Adicione registros antes de imprimir.');
        return;
      }
      preparePrintTables();
      setPrintSurface(document.getElementById('print-area'));
      window.print();
    });

    saveButton.addEventListener('click', () => {
      syncStorage();
      alert('Dados salvos com sucesso.');
      focusAutoInput();
    });

    resetButton.addEventListener('click', () => {
      const confirmReset = confirm('Deseja realmente resetar todos os dados?');
      if (!confirmReset) return;
      dataEntries = [];
      renderTable();
      updateLastCode(null, null, null);
      localStorage.removeItem(STORAGE_KEY);
      focusAutoInput();
    });

    const downloadCSV = () => {
      if (!dataEntries.length) {
        alert('N√£o h√° dados para baixar.');
        return;
      }
      const sorted = [...dataEntries].sort((a, b) =>
        a.code.localeCompare(b.code, 'pt-BR', {
          numeric: true,
          sensitivity: 'base'
        })
      );
      const lines = [];
      const title = getCurrentTitle();
      lines.push(`"${title}"`);
      lines.push('Produto;Quantidade');
      sorted.forEach((entry) => {
        lines.push(`${entry.code};${entry.quantity}`);
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${title}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      focusAutoInput();
    };

    downloadButton.addEventListener('click', downloadCSV);

    const downloadInventoryCSV = () => {
      if (!inventoryData.length) {
        alert('Importe dados antes de exportar.');
        return;
      }
      const lines = [];
      const today = new Date().toLocaleDateString('pt-BR');
      const fileTitle = `${getStoreValue()}-${getProductValue()}-${today}-conferencia`;
      lines.push('C√≥digo;Produto;Saldo Cont√°bil;Saldo em Loja;Diferen√ßa');
      inventoryData.forEach((entry) => {
        const contabil = entry.saldoContabil != null ? entry.saldoContabil : '';
        const loja = entry.saldoLoja != null ? entry.saldoLoja : '';
        const diff = entry.saldoContabil != null && entry.saldoLoja != null ? entry.saldoContabil - entry.saldoLoja : '';
        lines.push(`${entry.codigo};${entry.produto || ''};${contabil};${loja};${diff}`);
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${fileTitle}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    if (inventoryExportButton) {
      inventoryExportButton.addEventListener('click', downloadInventoryCSV);
    }

    if (inventorySaveButton) {
      inventorySaveButton.addEventListener('click', () => {
        syncStorage();
        alert('Dados de confer√™ncia salvos com sucesso.');
      });
    }

    if (inventoryPrintButton) {
      inventoryPrintButton.addEventListener('click', () => {
        if (!inventoryData.length && !dataEntries.length) {
          alert('Importe dados de estoque ou cadastre c√≥digos para gerar o relat√≥rio.');
          return;
        }
        buildInventoryReport();
        setPrintSurface(inventoryReportArea);
        window.print();
      });
    }

    let verifyModalOpen = false;

    const resetVerifyModal = () => {
      pendingVerifyCode = null;
      verifyMessage.textContent = '';
      verifyCodeInput.value = '';
      verifyPrompt.classList.add('hidden');
    };

    const closeModal = () => {
      modalOverlay.classList.remove('active');
      verifyModal.classList.remove('active');
      editModal.classList.remove('active');
      resetVerifyModal();
      currentEditingCode = null;
      verifyModalOpen = false;
      focusAutoInput();
    };

    const showModal = (modalElement) => {
      modalOverlay.classList.add('active');
      verifyModal.classList.remove('active');
      editModal.classList.remove('active');
      modalElement.classList.add('active');
    };

    const openVerifyModal = () => {
      resetVerifyModal();
      showModal(verifyModal);
      verifyModalOpen = true;
      setTimeout(() => verifyCodeInput.focus({ preventScroll: true }), 50);
    };

    const openEditModal = (code) => {
      const entry = dataEntries.find((item) => item.code === code);
      if (!entry) {
        alert('Item n√£o encontrado.');
        return;
      }
      currentEditingCode = entry.code;
      editCodeDisplay.textContent = entry.code;
      editQtyInput.value = entry.quantity;
      showModal(editModal);
      setTimeout(() => editQtyInput.focus({ preventScroll: true }), 50);
    };

    verifySubmit.addEventListener('click', () => {
      const code = sanitizeCode(verifyCodeInput.value);
      if (!code) {
        verifyMessage.textContent = 'Informe um c√≥digo v√°lido.';
        verifyPrompt.classList.add('hidden');
        return;
      }
      const entry = dataEntries.find((item) => item.code === code);
      if (entry) {
        pendingVerifyCode = entry.code;
        verifyMessage.textContent = 'Produto j√° cadastrado. Gostaria de edit√°-lo?';
        verifyPrompt.classList.remove('hidden');
      } else {
        verifyMessage.textContent = 'Produto n√£o cadastrado.';
        verifyPrompt.classList.add('hidden');
      }
    });

    verifyCodeInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        verifySubmit.click();
      }
    });

    verifyCodeInput.addEventListener('input', () => {
      const sanitized = sanitizeCode(verifyCodeInput.value);
      if (sanitized !== verifyCodeInput.value) {
        verifyCodeInput.value = sanitized;
      }
    });

    verifyClose.addEventListener('click', () => {
      closeModal();
    });

    verifyNoEdit.addEventListener('click', () => {
      closeModal();
    });

    verifyYesEdit.addEventListener('click', () => {
      if (pendingVerifyCode) {
        openEditModal(pendingVerifyCode);
      }
    });

    editCancel.addEventListener('click', () => {
      closeModal();
    });

    editSave.addEventListener('click', () => {
      const quantity = Number(editQtyInput.value) || 0;
      if (quantity <= 0) {
        alert('Informe uma quantidade v√°lida.');
        return;
      }
      const entry = dataEntries.find((item) => item.code === currentEditingCode);
      if (!entry) {
        alert('Item n√£o encontrado.');
        closeModal();
        return;
      }
      entry.quantity = quantity;
      renderTable();
      updateLastCode(entry.code, null, 'manual');
      syncStorage();
      closeModal();
    });

    modalOverlay.addEventListener('click', (event) => {
      if (event.target === modalOverlay) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && verifyModalOpen) {
        closeModal();
      }
    });

    tableBody.addEventListener('click', (event) => {
      const target = event.target;
      if (target instanceof HTMLElement) {
        if (target.classList.contains('edit-action')) {
          openEditModal(target.dataset.code);
        }
        if (target.classList.contains('delete-action')) {
          const code = target.dataset.code;
          const confirmDelete = confirm(`Deseja excluir o item "${code}"?`);
          if (!confirmDelete) return;
          dataEntries = dataEntries.filter((item) => item.code !== code);
          renderTable();
          if (!dataEntries.length) {
            updateLastCode(null, null, null);
          }
          syncStorage();
        }
      }
    });

    document.addEventListener('keydown', (event) => {
      if ((event.ctrlKey || event.metaKey) && ['w', 'W', 'r', 'R'].includes(event.key)) {
        event.preventDefault();
      }
      if (event.key === 'F5' || (event.altKey && event.key === 'F4')) {
        event.preventDefault();
      }
    });

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        focusAutoInput();
      }
    });

    window.addEventListener('load', () => {
      loadStorage();
      renderTable();
      renderInventoryTable();
      updateInventorySummary();
      focusAutoInput();
    });

    window.addEventListener('beforeunload', (event) => {
      if (dataEntries.length || inventoryData.length) {
        event.preventDefault();
        event.returnValue = '';
      }
    });

    window.addEventListener('afterprint', () => {
      resetPrintSurface();
      focusAutoInput();
    });

  </script>
</body>
</html>
